<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>FlowDesk ‚Äî OFM Command Center</title>
<style>
  :root {
    --bg: #0d0d0f;
    --bg2: #141417;
    --bg3: #1a1a1f;
    --border: #2a2a35;
    --accent: #a855f7;
    --accent2: #7c3aed;
    --accent-dim: rgba(168,85,247,0.15);
    --text: #f0f0f5;
    --text2: #9090a0;
    --text3: #606070;
    --green: #22c55e;
    --red: #ef4444;
    --orange: #f97316;
    --blue: #3b82f6;
    --sidebar-w: 220px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; font-size: 14px; height: 100vh; overflow: hidden; }

  /* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ */
  #auth-screen {
    display: flex; align-items: center; justify-content: center;
    height: 100vh; background: var(--bg);
  }
  .auth-card {
    background: var(--bg2); border: 1px solid var(--border); border-radius: 16px;
    padding: 40px; width: 400px; display: flex; flex-direction: column; gap: 20px;
  }
  .auth-logo { font-size: 22px; font-weight: 700; letter-spacing: -0.5px; }
  .auth-logo span { color: var(--accent); }
  .auth-card h2 { font-size: 18px; font-weight: 600; color: var(--text); }
  .auth-card p { color: var(--text2); font-size: 13px; }
  .field { display: flex; flex-direction: column; gap: 6px; }
  .field label { font-size: 12px; color: var(--text2); font-weight: 500; }
  .field input {
    background: var(--bg3); border: 1px solid var(--border); border-radius: 8px;
    padding: 10px 12px; color: var(--text); font-size: 14px; outline: none;
    transition: border-color 0.15s;
  }
  .field input:focus { border-color: var(--accent); }
  .btn-primary {
    background: var(--accent); color: #fff; border: none; border-radius: 8px;
    padding: 11px; font-size: 14px; font-weight: 600; cursor: pointer;
    transition: background 0.15s;
  }
  .btn-primary:hover { background: var(--accent2); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
  .auth-err { color: var(--red); font-size: 13px; text-align: center; }
  .auth-toggle { color: var(--text2); font-size: 13px; text-align: center; }
  .auth-toggle a { color: var(--accent); cursor: pointer; text-decoration: none; }
  .auth-toggle a:hover { text-decoration: underline; }

  /* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
  #app { display: none; height: 100vh; flex-direction: row; }

  /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
  .sidebar {
    width: var(--sidebar-w); background: var(--bg2); border-right: 1px solid var(--border);
    display: flex; flex-direction: column; flex-shrink: 0; overflow: hidden;
  }
  .sidebar-header {
    padding: 20px 16px 16px; border-bottom: 1px solid var(--border);
    display: flex; flex-direction: column; gap: 4px;
  }
  .sidebar-logo { font-size: 16px; font-weight: 700; }
  .sidebar-logo span { color: var(--accent); }
  .sidebar-org { font-size: 11px; color: var(--text3); }
  .nav { padding: 12px 8px; display: flex; flex-direction: column; gap: 2px; flex: 1; }
  .nav-item {
    display: flex; align-items: center; gap: 10px; padding: 9px 10px; border-radius: 8px;
    color: var(--text2); cursor: pointer; transition: all 0.15s; font-size: 13px;
    border: none; background: transparent; text-align: left; width: 100%;
  }
  .nav-item:hover { background: var(--bg3); color: var(--text); }
  .nav-item.active { background: var(--accent-dim); color: var(--accent); font-weight: 500; }
  .nav-item .icon { font-size: 15px; width: 18px; flex-shrink: 0; }
  .nav-badge {
    margin-left: auto; background: var(--accent); color: #fff;
    font-size: 10px; font-weight: 700; padding: 1px 6px; border-radius: 10px; min-width: 18px; text-align: center;
  }
  .sidebar-bottom {
    padding: 12px 8px; border-top: 1px solid var(--border);
    display: flex; flex-direction: column; gap: 6px;
  }
  .user-info {
    display: flex; align-items: center; gap: 8px; padding: 8px 10px; border-radius: 8px;
  }
  .user-avatar {
    width: 28px; height: 28px; border-radius: 50%; background: var(--accent-dim);
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; color: var(--accent); flex-shrink: 0;
  }
  .user-name { font-size: 12px; font-weight: 500; color: var(--text); }
  .user-role { font-size: 10px; color: var(--text3); }
  .btn-logout {
    background: transparent; border: 1px solid var(--border); border-radius: 8px;
    padding: 8px; color: var(--text2); cursor: pointer; font-size: 12px;
    transition: all 0.15s; text-align: center;
  }
  .btn-logout:hover { border-color: var(--red); color: var(--red); }

  /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
  .main { flex: 1; overflow: hidden; display: flex; flex-direction: column; }

  /* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ */
  .panel { display: none; flex: 1; overflow: auto; padding: 24px; flex-direction: column; gap: 20px; }
  .panel.active { display: flex; }

  .panel-title { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
  .panel-subtitle { font-size: 13px; color: var(--text2); margin-top: 4px; }

  /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
  .stat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
  .stat-card {
    background: var(--bg2); border: 1px solid var(--border); border-radius: 12px;
    padding: 18px; display: flex; flex-direction: column; gap: 6px;
  }
  .stat-label { font-size: 11px; color: var(--text2); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-value { font-size: 26px; font-weight: 700; color: var(--text); }
  .stat-sub { font-size: 12px; color: var(--text2); }
  .stat-up { color: var(--green); }
  .stat-down { color: var(--red); }

  .card {
    background: var(--bg2); border: 1px solid var(--border); border-radius: 12px; overflow: hidden;
  }
  .card-header {
    padding: 14px 16px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .card-title { font-size: 13px; font-weight: 600; }
  .card-body { padding: 16px; }

  /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; }
  th {
    padding: 10px 12px; font-size: 11px; color: var(--text2); font-weight: 500;
    text-align: left; border-bottom: 1px solid var(--border);
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  td { padding: 12px 12px; font-size: 13px; border-bottom: 1px solid var(--border); vertical-align: middle; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: rgba(255,255,255,0.02); }
  .badge {
    display: inline-flex; align-items: center; padding: 3px 8px; border-radius: 6px;
    font-size: 11px; font-weight: 500;
  }
  .badge-green { background: rgba(34,197,94,0.15); color: var(--green); }
  .badge-red { background: rgba(239,68,68,0.15); color: var(--red); }
  .badge-orange { background: rgba(249,115,22,0.15); color: var(--orange); }
  .badge-purple { background: var(--accent-dim); color: var(--accent); }
  .badge-blue { background: rgba(59,130,246,0.15); color: var(--blue); }
  .badge-gray { background: rgba(144,144,160,0.15); color: var(--text2); }

  /* ‚îÄ‚îÄ INBOX ‚îÄ‚îÄ */
  #panel-inbox { flex-direction: row; padding: 0; gap: 0; overflow: hidden; }

  .inbox-sidebar {
    width: 320px; border-right: 1px solid var(--border); display: flex; flex-direction: column;
    background: var(--bg2); flex-shrink: 0;
  }
  .inbox-header { padding: 16px; border-bottom: 1px solid var(--border); }
  .inbox-header h2 { font-size: 15px; font-weight: 700; margin-bottom: 10px; }
  .inbox-search {
    width: 100%; background: var(--bg3); border: 1px solid var(--border); border-radius: 8px;
    padding: 8px 12px; color: var(--text); font-size: 13px; outline: none;
  }
  .inbox-search:focus { border-color: var(--accent); }
  .inbox-filters {
    padding: 10px 16px; border-bottom: 1px solid var(--border);
    display: flex; gap: 6px; flex-wrap: wrap;
  }
  .filter-btn {
    padding: 5px 10px; border-radius: 20px; border: 1px solid var(--border);
    background: transparent; color: var(--text2); font-size: 11px; cursor: pointer; transition: all 0.15s;
  }
  .filter-btn.active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
  .inbox-list { overflow-y: auto; flex: 1; }
  .conv-item {
    padding: 12px 16px; border-bottom: 1px solid var(--border); cursor: pointer;
    transition: background 0.1s; display: flex; gap: 10px; align-items: flex-start;
  }
  .conv-item:hover { background: var(--bg3); }
  .conv-item.active { background: var(--accent-dim); }
  .conv-avatar {
    width: 36px; height: 36px; border-radius: 50%; background: var(--bg3);
    object-fit: cover; flex-shrink: 0; display: flex; align-items: center; justify-content: center;
    font-size: 13px; font-weight: 600; color: var(--text2); overflow: hidden;
  }
  .conv-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
  .conv-info { flex: 1; min-width: 0; }
  .conv-name { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .conv-preview { font-size: 12px; color: var(--text2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
  .conv-time { font-size: 11px; color: var(--text3); white-space: nowrap; margin-left: 6px; }
  .unread-dot {
    width: 8px; height: 8px; border-radius: 50%; background: var(--accent);
    margin-top: 5px; flex-shrink: 0;
  }
  .conv-item.unread .conv-name { color: var(--accent); }

  .convo-main { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-width: 0; }
  .convo-topbar {
    padding: 14px 20px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
  }
  .convo-fan-name { font-size: 15px; font-weight: 700; }
  .convo-fan-meta { font-size: 12px; color: var(--text2); }
  .convo-msgs { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 10px; }
  .msg { max-width: 72%; display: flex; flex-direction: column; gap: 2px; }
  .msg.outbound { align-self: flex-end; align-items: flex-end; }
  .msg.inbound { align-self: flex-start; align-items: flex-start; }
  .msg-bubble {
    padding: 10px 14px; border-radius: 14px; font-size: 13px; line-height: 1.5;
  }
  .msg.outbound .msg-bubble { background: var(--accent); color: #fff; border-bottom-right-radius: 4px; }
  .msg.inbound .msg-bubble { background: var(--bg3); color: var(--text); border-bottom-left-radius: 4px; }
  .msg-time { font-size: 10px; color: var(--text3); padding: 0 4px; }
  .convo-input-wrap {
    padding: 14px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; flex-shrink: 0;
  }
  .convo-input {
    flex: 1; background: var(--bg3); border: 1px solid var(--border); border-radius: 10px;
    padding: 10px 14px; color: var(--text); font-size: 13px; outline: none; resize: none;
    font-family: inherit; max-height: 120px;
  }
  .convo-input:focus { border-color: var(--accent); }
  .btn-send {
    background: var(--accent); border: none; border-radius: 10px; padding: 10px 16px;
    color: #fff; font-size: 13px; font-weight: 600; cursor: pointer; transition: background 0.15s;
    align-self: flex-end;
  }
  .btn-send:hover { background: var(--accent2); }
  .convo-empty {
    flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
    color: var(--text3); gap: 10px;
  }
  .convo-empty .icon { font-size: 40px; }

  /* ‚îÄ‚îÄ ACCOUNT SELECTOR ‚îÄ‚îÄ */
  .acct-select-wrap { padding: 12px 16px; border-bottom: 1px solid var(--border); }
  .acct-select {
    width: 100%; background: var(--bg3); border: 1px solid var(--border); border-radius: 8px;
    padding: 8px 10px; color: var(--text); font-size: 13px; cursor: pointer; outline: none;
  }
  .acct-select:focus { border-color: var(--accent); }

  /* ‚îÄ‚îÄ LOADING / EMPTY ‚îÄ‚îÄ */
  .loading { color: var(--text3); font-size: 13px; padding: 30px; text-align: center; }
  .empty { color: var(--text3); font-size: 13px; text-align: center; padding: 40px 20px; }

  /* ‚îÄ‚îÄ TOASTS ‚îÄ‚îÄ */
  #toast-wrap {
    position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column;
    gap: 8px; z-index: 9999; pointer-events: none;
  }
  .toast {
    padding: 12px 16px; border-radius: 10px; font-size: 13px; font-weight: 500;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4); animation: slideIn 0.2s ease;
    pointer-events: all;
  }
  .toast-success { background: #1a3d2b; border: 1px solid var(--green); color: var(--green); }
  .toast-error { background: #3d1a1a; border: 1px solid var(--red); color: var(--red); }
  .toast-info { background: var(--bg3); border: 1px solid var(--border); color: var(--text2); }
  @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
  .btn-sm {
    background: var(--bg3); border: 1px solid var(--border); border-radius: 6px;
    padding: 6px 12px; color: var(--text2); font-size: 12px; cursor: pointer; transition: all 0.15s;
  }
  .btn-sm:hover { border-color: var(--accent); color: var(--accent); }
  .btn-sm.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
  .btn-sm.primary:hover { background: var(--accent2); }
  .flex-row { display: flex; gap: 10px; align-items: center; }
  .scroll-y { overflow-y: auto; }
  input[type="text"], input[type="email"], input[type="password"], select, textarea {
    background: var(--bg3); border: 1px solid var(--border); border-radius: 8px;
    padding: 8px 12px; color: var(--text); font-size: 13px; outline: none; font-family: inherit;
  }
  input:focus, select:focus, textarea:focus { border-color: var(--accent); }
  select { cursor: pointer; }

  /* ‚îÄ‚îÄ FAN DETAIL PANEL ‚îÄ‚îÄ */
  .fan-detail-panel {
    width: 300px; flex-shrink: 0; border-left: 1px solid var(--border);
    background: var(--bg2); display: none; flex-direction: column;
    overflow-y: auto; height: 100%;
  }
  .fan-detail-panel.visible { display: flex; }
  .fdp-section {
    padding: 16px; border-bottom: 1px solid var(--border);
  }
  .fdp-section-title {
    font-size: 15px; font-weight: 700; color: var(--text); margin-bottom: 12px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .fdp-spend-cards {
    display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;
  }
  .fdp-spend-card {
    background: var(--bg3); border: 1px solid var(--border); border-radius: 10px;
    padding: 12px;
  }
  .fdp-card-label { font-size: 11px; color: var(--text2); margin-bottom: 6px; }
  .fdp-card-value { font-size: 20px; font-weight: 700; color: var(--text); }
  .fdp-card-sub { font-size: 11px; color: var(--text3); margin-top: 4px; }
  .fdp-stat-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 8px 0; border-bottom: 1px solid var(--border);
  }
  .fdp-stat-row:last-child { border-bottom: none; }
  .fdp-stat-label { font-size: 13px; color: var(--text2); }
  .fdp-stat-value { font-size: 13px; font-weight: 600; color: var(--text); text-align: right; }
  .fdp-stat-sub { font-size: 11px; color: var(--text3); }
  .fdp-fan-type-badge {
    background: var(--blue); color: #fff; font-size: 12px; font-weight: 600;
    padding: 3px 12px; border-radius: 20px;
  }
  .fdp-nickname-display {
    background: var(--bg3); border: 1px solid var(--border); border-radius: 8px;
    padding: 10px 12px; font-size: 13px; color: var(--text2); min-height: 40px;
  }
  .fdp-nickname-edit { display: none; gap: 6px; }
  .fdp-nickname-edit input {
    flex: 1; background: var(--bg3); border: 1px solid var(--accent); border-radius: 8px;
    padding: 8px 10px; color: var(--text); font-size: 13px; outline: none;
  }
  .fdp-nickname-save-btn {
    background: var(--accent); border: none; border-radius: 8px; padding: 8px 12px;
    color: #fff; font-size: 12px; font-weight: 600; cursor: pointer;
  }
  .fdp-nickname-cancel-btn {
    background: var(--bg3); border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px;
    color: var(--text2); font-size: 12px; cursor: pointer;
  }
  .fdp-edit-btn {
    background: transparent; border: none; color: var(--text2); font-size: 13px;
    cursor: pointer; padding: 2px 6px; border-radius: 4px;
  }
  .fdp-edit-btn:hover { color: var(--text); background: var(--bg3); }
  .fdp-beta-badge {
    background: #d946ef; color: #fff; font-size: 10px; font-weight: 700;
    padding: 2px 8px; border-radius: 20px;
  }
  .fdp-notes-filters { display: flex; gap: 6px; margin-bottom: 10px; }
  .fdp-notes-filter-btn {
    padding: 5px 12px; border-radius: 20px; border: 1px solid var(--border);
    background: transparent; color: var(--text2); font-size: 12px; cursor: pointer;
  }
  .fdp-notes-filter-btn.active {
    background: #166534; border-color: var(--green); color: var(--green);
  }
  .fdp-ask-input-wrap {
    display: flex; align-items: center; gap: 8px;
    background: var(--bg3); border: 1px solid var(--border); border-radius: 8px;
    padding: 8px 12px; margin-bottom: 8px;
  }
  .fdp-ask-input-wrap span { color: var(--text3); font-size: 14px; }
  .fdp-ask-input {
    flex: 1; background: transparent; border: none; color: var(--text2); font-size: 13px;
    outline: none;
  }
  .fdp-ask-input::placeholder { color: var(--text3); }
  .fdp-notes-add-wrap {
    position: relative; margin-bottom: 12px;
  }
  .fdp-notes-add-input {
    width: 100%; background: var(--bg3); border: 1px solid var(--border); border-radius: 8px;
    padding: 10px 40px 10px 12px; color: var(--text2); font-size: 13px; outline: none;
  }
  .fdp-notes-add-input::placeholder { color: var(--text3); }
  .fdp-notes-add-btn {
    position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
    background: transparent; border: none; color: var(--text2); font-size: 18px;
    cursor: pointer; line-height: 1; padding: 4px;
  }
  .fdp-notes-add-btn:hover { color: var(--text); }
  .fdp-notes-empty { color: var(--text3); font-size: 13px; text-align: center; padding: 16px 0; }
  .fdp-note-item {
    padding: 8px 10px; background: var(--bg3); border-radius: 8px;
    font-size: 12px; color: var(--text2); margin-bottom: 6px; line-height: 1.5;
  }
  .fdp-notes-textarea {
    width: 100%; background: var(--bg3); border: 1px solid var(--border); border-radius: 8px;
    padding: 10px 12px; color: var(--text2); font-size: 13px; outline: none;
    resize: vertical; min-height: 100px; font-family: inherit;
  }
  .fdp-notes-textarea:focus { border-color: var(--accent); }
  .fdp-summary-period-btn {
    width: 100%; background: transparent; border: 1px solid var(--border); border-radius: 24px;
    padding: 10px; color: var(--text); font-size: 14px; font-weight: 600;
    cursor: pointer; margin-bottom: 8px; transition: border-color 0.15s;
  }
  .fdp-summary-period-btn:hover { border-color: var(--text2); }
  .fdp-generate-btn {
    width: 100%; background: #fff; border: none; border-radius: 24px;
    padding: 10px; color: #111; font-size: 14px; font-weight: 700;
    cursor: pointer; margin-bottom: 10px; transition: background 0.15s;
  }
  .fdp-generate-btn:hover { background: #e5e5e5; }
  .fdp-summary-hint { font-size: 12px; color: var(--text3); line-height: 1.5; }
  .fdp-summary-result {
    display: none; margin-top: 12px; background: var(--bg3); border-radius: 8px;
    padding: 12px; font-size: 12px; color: var(--text2); line-height: 1.6;
  }
  /* insights loading shimmer */
  .fdp-loading-text { color: var(--text3); font-size: 12px; font-style: italic; }
  /* ‚îÄ‚îÄ ANALYTICS REDESIGN ‚îÄ‚îÄ */
  .a-tabs { display:flex; gap:4px; background:var(--bg3); border-radius:8px; padding:4px; width:fit-content; margin-bottom:16px; }
  .a-tab { padding:6px 16px; border-radius:6px; border:none; background:transparent; color:var(--text2); font-size:13px; cursor:pointer; transition:all 0.15s; }
  .a-tab.active { background:var(--bg2); color:var(--text); font-weight:500; }
  .a-tab:hover:not(.active) { color:var(--text); }
  .a-period-row { display:flex; gap:8px; margin-bottom:16px; align-items:center; flex-wrap:wrap; }
  .a-period-pill { padding:5px 14px; border-radius:20px; border:1px solid var(--border); font-size:12px; color:var(--text2); cursor:pointer; background:transparent; transition:all 0.15s; }
  .a-period-pill.active { background:var(--bg3); color:var(--text); border-color:var(--text3); }
  .a-period-pill:hover:not(.active) { color:var(--text); }
  .a-stat-row { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-bottom:16px; }
  .a-stat-card { background:var(--bg2); border:1px solid var(--border); border-radius:12px; padding:18px; overflow:hidden; min-width:0; }
  .a-stat-card-label { font-size:12px; color:var(--text2); font-weight:500; margin-bottom:8px; }
  .a-stat-card-value { font-size:30px; font-weight:700; letter-spacing:-1px; line-height:1; }
  .a-stat-card-sub { font-size:12px; color:var(--text2); margin-top:4px; }
  .a-sparkline { display:block; margin-top:16px; height:50px !important; }
  .a-vs-badge { display:inline-flex; align-items:center; gap:4px; background:rgba(34,197,94,0.15); color:#22c55e; font-size:12px; padding:3px 10px; border-radius:20px; margin-top:6px; font-weight:500; }
  .a-stat-promo { background:linear-gradient(135deg, rgba(168,85,247,0.12), rgba(124,58,237,0.08)); }
  .a-promo-btn { margin-top:12px; padding:6px 14px; background:var(--bg); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:12px; cursor:pointer; display:inline-flex; align-items:center; gap:4px; }
  .a-promo-btn:hover { background:var(--bg3); }
  .a-main-grid { display:grid; grid-template-columns:2fr 1fr; gap:12px; }
  .a-card { background:var(--bg2); border:1px solid var(--border); border-radius:12px; padding:16px; min-width:0; }
  .a-toggle { display:flex; background:var(--bg3); border-radius:6px; padding:3px; }
  .a-toggle-btn { padding:4px 14px; border-radius:4px; border:none; background:transparent; color:var(--text2); font-size:12px; cursor:pointer; }
  .a-toggle-btn.active { background:var(--bg); color:var(--text); }
  .a-spender-row { display:flex; align-items:center; gap:10px; padding:10px 0; border-bottom:1px solid var(--border); }
  .a-spender-row:last-child { border-bottom:none; }
  .a-avatar { width:36px; height:36px; border-radius:50%; background:var(--bg3); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; color:var(--text); flex-shrink:0; }
  .a-avatar.sm { width:30px; height:30px; font-size:11px; }
  .a-see-more { width:100%; padding:8px; background:none; border:none; color:var(--text2); font-size:12px; cursor:pointer; margin-top:4px; }
  .a-see-more:hover { color:var(--text); }
  .a-live-badge { font-size:11px; color:#22c55e; display:inline-flex; align-items:center; gap:3px; }
  .a-tx-row { display:flex; align-items:flex-start; gap:10px; padding:10px 0; border-bottom:1px solid var(--border); }
  .a-tx-row:last-child { border-bottom:none; }
  .a-tx-info { flex:1; font-size:12px; line-height:1.4; }
  .a-tx-amount { font-size:13px; font-weight:700; margin-top:2px; }
  .a-tx-time { font-size:11px; color:var(--text2); text-align:right; white-space:nowrap; }
  .a-brow { display:flex; align-items:center; padding:10px 0; border-bottom:1px solid var(--border); }
  .a-brow:last-child { border-bottom:none; }
  .a-brow-dot { width:8px; height:8px; border-radius:50%; margin-right:10px; flex-shrink:0; }
  .a-brow-label { flex:1; font-size:13px; color:var(--text2); }
  .a-brow-amount { font-size:13px; font-weight:600; padding-right:12px; }
  .a-brow-badge { font-size:11px; padding:2px 8px; border-radius:20px; background:rgba(34,197,94,0.15); color:#22c55e; font-weight:500; }
  .a-donut-legend-row { display:flex; align-items:center; gap:8px; padding:5px 0; }
  .a-donut-legend-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
  .a-donut-legend-bar { flex:1; height:3px; border-radius:2px; background:var(--bg3); overflow:hidden; }
  .a-donut-legend-bar-fill { height:100%; border-radius:2px; }
  .a-donut-legend-label { font-size:12px; color:var(--text2); width:72px; }
  .a-donut-legend-amount { font-size:13px; font-weight:700; color:var(--text); }
  .a-col-left { display:flex; flex-direction:column; gap:12px; min-width:0; }
  .a-col-right { display:flex; flex-direction:column; gap:12px; }
  .a-bottom-pair { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  @media (max-width: 900px) {
    .a-stat-row { grid-template-columns:1fr 1fr; }
    .a-main-grid { grid-template-columns:1fr; }
    .a-bottom-pair { grid-template-columns:1fr; }
  }

  /* ‚îÄ‚îÄ OVERVIEW REDESIGN ‚îÄ‚îÄ */
  .ov-period-row { display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
  .ov-stat-row { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; }
  .ov-stat-card {
    background:var(--bg2); border:1px solid var(--border); border-radius:12px;
    padding:18px 20px;
  }
  .ov-stat-label { font-size:11px; color:var(--text2); font-weight:500; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px; }
  .ov-stat-value { font-size:28px; font-weight:700; letter-spacing:-1px; color:var(--text); line-height:1; }
  .ov-stat-sub { font-size:12px; color:var(--text3); margin-top:6px; }
  .ov-main-grid { display:grid; grid-template-columns:1fr 320px; gap:12px; }
  .ov-account-cards { display:flex; flex-direction:column; gap:10px; }
  .ov-acct-card {
    background:var(--bg2); border:1px solid var(--border); border-radius:12px;
    padding:16px; display:flex; align-items:center; gap:14px;
    transition: border-color 0.15s;
  }
  .ov-acct-card:hover { border-color: var(--text3); }
  .ov-acct-avatar {
    width:44px; height:44px; border-radius:50%; flex-shrink:0;
    background:var(--accent-dim); display:flex; align-items:center; justify-content:center;
    font-size:16px; font-weight:700; color:var(--accent);
    border:2px solid var(--border); overflow:hidden;
  }
  .ov-acct-avatar img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
  .ov-acct-info { flex:1; min-width:0; }
  .ov-acct-name { font-size:14px; font-weight:600; }
  .ov-acct-handle { font-size:12px; color:var(--text2); margin-top:2px; }
  .ov-acct-stats { display:flex; gap:24px; margin-top:10px; }
  .ov-acct-stat { display:flex; flex-direction:column; gap:2px; }
  .ov-acct-stat-val { font-size:16px; font-weight:700; }
  .ov-acct-stat-lbl { font-size:11px; color:var(--text3); }
  .ov-acct-actions { display:flex; flex-direction:column; gap:6px; align-items:flex-end; flex-shrink:0; }
  .ov-bottom-row { display:flex; gap:12px; }
  @media (max-width: 1100px) {
    .ov-stat-row { grid-template-columns:1fr 1fr; }
    .ov-main-grid { grid-template-columns:1fr; }
    .ov-bottom-row { flex-direction:column; }
    .ov-bottom-row > div:last-child { width:100%; }
  }

  /* ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ */
  .settings-tabs {
    display:flex; gap:4px; background:var(--bg3); border-radius:8px;
    padding:4px; width:fit-content;
  }
  .settings-tab {
    padding:6px 18px; border-radius:6px; border:none; background:transparent;
    color:var(--text2); font-size:13px; cursor:pointer; transition:all 0.15s;
  }
  .settings-tab.active { background:var(--bg2); color:var(--text); font-weight:500; }
  .settings-tab:hover:not(.active) { color:var(--text); }
  .settings-section { display:none; flex-direction:column; gap:16px; max-width:540px; }
  .settings-section.active { display:flex; }
  .s-plan-pill {
    display:inline-flex; align-items:center; padding:5px 14px; border-radius:20px;
    font-size:12px; font-weight:600; letter-spacing:0.3px;
  }
  .s-plan-starter { background:rgba(144,144,160,0.15); color:var(--text2); }
  .s-plan-pro     { background:rgba(59,130,246,0.15); color:var(--blue); }
  .s-plan-agency  { background:var(--accent-dim); color:var(--accent); }
  .s-feature-row  {
    display:flex; align-items:center; gap:10px; font-size:13px; color:var(--text2);
  }
  .s-feature-check { color:var(--green); font-size:15px; flex-shrink:0; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>

<!-- ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ -->
<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-logo">Flow<span>Desk</span></div>
    <div>
      <h2 id="auth-title">Welcome back</h2>
      <p style="margin-top:4px">Sign in to your agency dashboard</p>
    </div>
    <div id="signup-fields" style="display:none; flex-direction:column; gap:14px;">
      <div class="field"><label>Full Name</label><input id="f-name" type="text" placeholder="Your name" /></div>
      <div class="field"><label>Agency Name</label><input id="f-agency" type="text" placeholder="Your agency name" /></div>
    </div>
    <div style="display:flex;flex-direction:column;gap:14px;">
      <div class="field"><label>Email</label><input id="f-email" type="email" placeholder="you@agency.com" /></div>
      <div class="field"><label>Password</label><input id="f-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
    </div>
    <div id="auth-err" class="auth-err" style="display:none"></div>
    <button class="btn-primary" id="auth-btn" onclick="authSubmit()">Sign In</button>
    <div class="auth-toggle" id="auth-toggle">
      Don't have an account? <a onclick="toggleAuth()">Create one</a>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ APP ‚îÄ‚îÄ‚îÄ -->
<div id="app">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">Flow<span>Desk</span></div>
      <div class="sidebar-org" id="org-name">Loading...</div>
    </div>
    <nav class="nav">
      <button class="nav-item active" onclick="showPanel('overview')" id="nav-overview">
        <span class="icon">üìä</span> Overview
      </button>
      <button class="nav-item" onclick="showPanel('inbox')" id="nav-inbox">
        <span class="icon">üí¨</span> Inbox
        <span class="nav-badge" id="inbox-badge" style="display:none">0</span>
      </button>
      <button class="nav-item" onclick="showPanel('analytics')" id="nav-analytics">
        <span class="icon">üìà</span> Analytics
      </button>
      <button class="nav-item" onclick="showPanel('scripts')" id="nav-scripts">
        <span class="icon">ü§ñ</span> Scripts
      </button>
      <button class="nav-item" onclick="showPanel('accounts')" id="nav-accounts">
        <span class="icon">üîó</span> Accounts
      </button>
      <button class="nav-item" onclick="showPanel('team')" id="nav-team">
        <span class="icon">üè¢</span> Team
      </button>
      <button class="nav-item" onclick="showPanel('settings')" id="nav-settings">
        <span class="icon">‚öôÔ∏è</span> Settings
      </button>
    </nav>
    <div class="sidebar-bottom">
      <div class="user-info">
        <div class="user-avatar" id="user-avatar">?</div>
        <div>
          <div class="user-name" id="user-name">‚Äî</div>
          <div class="user-role" id="user-role">‚Äî</div>
        </div>
      </div>
      <button class="btn-logout" onclick="logout()">Sign out</button>
    </div>
  </div>

  <!-- Main -->
  <div class="main">

    <!-- ‚îÄ‚îÄ OVERVIEW ‚îÄ‚îÄ -->
    <div class="panel active" id="panel-overview">
      <!-- Header row -->
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;">
        <div>
          <div class="panel-title" id="overview-greeting">Overview</div>
          <div class="panel-subtitle" id="overview-sub">Loading your dashboard...</div>
        </div>
        <div class="ov-period-row" id="ov-period-row">
          <div class="a-period-pill active" onclick="setOvPeriod('today')" id="ovp-today">Today</div>
          <div class="a-period-pill" onclick="setOvPeriod('yesterday')" id="ovp-yesterday">Yesterday</div>
          <div class="a-period-pill" onclick="setOvPeriod('7d')" id="ovp-7d">7d</div>
          <div class="a-period-pill" onclick="setOvPeriod('14d')" id="ovp-14d">14d</div>
          <div class="a-period-pill" onclick="setOvPeriod('30d')" id="ovp-30d">30d</div>
          <div class="a-period-pill" onclick="setOvPeriod('month')" id="ovp-month">This month</div>
          <div class="a-period-pill" onclick="setOvPeriod('year')" id="ovp-year">This year</div>
          <div class="a-period-pill" onclick="setOvPeriod('all')" id="ovp-all">All time</div>
        </div>
      </div>

      <!-- KPI stat cards -->
      <div class="ov-stat-row">
        <div class="ov-stat-card">
          <div class="ov-stat-label">Total Revenue</div>
          <div class="ov-stat-value" id="ov-earn">‚Äî</div>
          <div class="ov-stat-sub" id="ov-earn-sub">Last 30 days</div>
        </div>
        <div class="ov-stat-card">
          <div class="ov-stat-label">Subscribers</div>
          <div class="ov-stat-value" id="ov-subs">‚Äî</div>
          <div class="ov-stat-sub">Active now</div>
        </div>
        <div class="ov-stat-card">
          <div class="ov-stat-label">New Subscribers</div>
          <div class="ov-stat-value" id="ov-new-subs">‚Äî</div>
          <div class="ov-stat-sub" id="ov-new-sub-label">Last 30 days</div>
        </div>
        <div class="ov-stat-card">
          <div class="ov-stat-label">Active Accounts</div>
          <div class="ov-stat-value" id="ov-accts">‚Äî</div>
          <div class="ov-stat-sub" id="ov-team-sub">‚Äî team members</div>
        </div>
      </div>

      <!-- Account cards + Top Spenders -->
      <div class="ov-main-grid">
        <div class="ov-account-cards" id="ov-account-cards">
          <div class="loading">Loading accounts...</div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">Top Spenders</div>
            <select id="ov-spenders-acct" onchange="loadOvTopSpenders()" style="background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:4px 8px;color:var(--text);font-size:12px;cursor:pointer;outline:none;max-width:120px;"></select>
          </div>
          <div id="ov-top-spenders"><div class="loading">Loading...</div></div>
        </div>
      </div>

      <!-- Recent Transactions + Quick Links -->
      <div class="ov-bottom-row">
        <div class="card" style="flex:1;min-width:0;">
          <div class="card-header">
            <div class="card-title">Recent Transactions</div>
            <select id="ov-tx-acct" onchange="loadOvTransactions()" style="background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:4px 8px;color:var(--text);font-size:12px;cursor:pointer;outline:none;max-width:120px;"></select>
          </div>
          <div id="ov-recent-tx" style="padding:0 16px;"><div class="loading">Loading...</div></div>
        </div>
        <div style="display:flex;flex-direction:column;gap:12px;width:260px;flex-shrink:0;">
          <div class="card">
            <div class="card-header"><div class="card-title">Quick Actions</div></div>
            <div style="padding:10px 12px;display:flex;flex-direction:column;gap:6px;">
              <button class="btn-sm" style="width:100%;text-align:left;padding:10px 12px;font-size:13px;" onclick="showPanel('inbox')">üí¨ Open Inbox</button>
              <button class="btn-sm" style="width:100%;text-align:left;padding:10px 12px;font-size:13px;" onclick="showPanel('analytics')">üìà View Analytics</button>
              <button class="btn-sm" style="width:100%;text-align:left;padding:10px 12px;font-size:13px;" onclick="showPanel('accounts')">üîó Manage Accounts</button>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <div class="card-title">Team</div>
              <button class="btn-sm" onclick="showPanel('team')">Manage</button>
            </div>
            <div id="ov-team"><div class="loading">Loading...</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ INBOX ‚îÄ‚îÄ -->
    <div class="panel" id="panel-inbox">
      <div class="inbox-sidebar">
        <div class="inbox-header">
          <h2>Inbox</h2>
          <input class="inbox-search" id="inbox-search" placeholder="Search fans..." oninput="filterConvos()" />
        </div>
        <div class="acct-select-wrap">
          <select class="acct-select" id="inbox-acct" onchange="loadInbox()">
            <option value="">Select account...</option>
          </select>
        </div>
        <div class="inbox-filters">
          <button class="filter-btn active" onclick="setFilter(this,'all')">All</button>
          <button class="filter-btn" onclick="setFilter(this,'unread')">Unread</button>
          <button class="filter-btn" onclick="setFilter(this,'follow_up')">Follow-up</button>
        </div>
        <div class="inbox-list" id="inbox-list">
          <div class="loading">Select an account to load inbox</div>
        </div>
      </div>
      <div class="convo-main" id="convo-main">
        <div class="convo-empty">
          <div class="icon">üí¨</div>
          <div>Select a conversation</div>
        </div>
      </div>
      <!-- Fan Detail Panel -->
      <div class="fan-detail-panel" id="fan-detail-panel">
        <!-- Spending behavior -->
        <div class="fdp-section">
          <div class="fdp-section-title">Spending behavior</div>
          <div class="fdp-spend-cards">
            <div class="fdp-spend-card">
              <div class="fdp-card-label">Total spent</div>
              <div class="fdp-card-value" id="fdp-total-spent">$0.00</div>
              <div class="fdp-card-sub" id="fdp-since">‚Äî</div>
            </div>
            <div class="fdp-spend-card">
              <div class="fdp-card-label">Last spend</div>
              <div class="fdp-card-value" id="fdp-last-spend" style="font-size:15px;margin-top:4px;">N/A</div>
            </div>
          </div>
          <div class="fdp-stat-row">
            <div class="fdp-stat-label">Total PPV</div>
            <div class="fdp-stat-value">
              <div id="fdp-ppv-total">$0.00</div>
              <div class="fdp-stat-sub" id="fdp-ppv-avg">$0.00 avg</div>
            </div>
          </div>
          <div class="fdp-stat-row">
            <div class="fdp-stat-label">Total Tip</div>
            <div class="fdp-stat-value">
              <div id="fdp-tip-total">$0.00</div>
              <div class="fdp-stat-sub" id="fdp-tip-avg">$0.00 avg</div>
            </div>
          </div>
        </div>
        <!-- Subscription -->
        <div class="fdp-section">
          <div class="fdp-section-title">Subscription</div>
          <div class="fdp-stat-row">
            <div class="fdp-stat-label">Fan type</div>
            <div><span class="fdp-fan-type-badge" id="fdp-fan-type">Follower</span></div>
          </div>
          <div class="fdp-stat-row">
            <div class="fdp-stat-label">Cost</div>
            <div class="fdp-stat-value" id="fdp-sub-cost">-</div>
          </div>
          <div class="fdp-stat-row">
            <div class="fdp-stat-label">Duration</div>
            <div class="fdp-stat-value" id="fdp-sub-duration">1 month</div>
          </div>
          <div class="fdp-stat-row">
            <div class="fdp-stat-label">Auto-renewal</div>
            <div class="fdp-stat-value" id="fdp-sub-renew">-</div>
          </div>
        </div>
        <!-- Nickname -->
        <div class="fdp-section">
          <div class="fdp-section-title">
            Nickname
            <button class="fdp-edit-btn" onclick="toggleNicknameEdit()">Edit</button>
          </div>
          <div class="fdp-nickname-display" id="fdp-nickname-display"></div>
          <div class="fdp-nickname-edit" id="fdp-nickname-edit" style="display:none;">
            <input type="text" id="fdp-nickname-input" placeholder="Enter nickname..." />
            <button class="fdp-nickname-save-btn" onclick="saveNickname()">Save</button>
            <button class="fdp-nickname-cancel-btn" onclick="toggleNicknameEdit()">‚úï</button>
          </div>
        </div>
        <!-- Notes (Beta) -->
        <div class="fdp-section">
          <div class="fdp-section-title">
            Notes
            <span class="fdp-beta-badge">Beta</span>
          </div>
          <div class="fdp-notes-filters">
            <button class="fdp-notes-filter-btn active" onclick="setNoteFilter(this,'all')">All</button>
            <button class="fdp-notes-filter-btn" onclick="setNoteFilter(this,'must_know')">Must know</button>
            <button class="fdp-notes-filter-btn" onclick="setNoteFilter(this,'top_facts')">Top facts</button>
          </div>
          <div class="fdp-ask-input-wrap">
            <span>üîç</span>
            <input class="fdp-ask-input" id="fdp-ask-input" placeholder="Ask anything about this fan..." />
          </div>
          <div class="fdp-notes-add-wrap">
            <input class="fdp-notes-add-input" id="fdp-note-input" placeholder="Type notes about this fan..." onkeydown="if(event.key==='Enter')addFanNote()" />
            <button class="fdp-notes-add-btn" onclick="addFanNote()">+</button>
          </div>
          <div id="fdp-notes-list"><div class="fdp-notes-empty">No facts found</div></div>
        </div>
        <!-- Notes textarea -->
        <div class="fdp-section">
          <div class="fdp-section-title">Notes</div>
          <textarea class="fdp-notes-textarea" id="fdp-notes-textarea" placeholder="" onblur="saveFanNotes()"></textarea>
        </div>
        <!-- Chat summary -->
        <div class="fdp-section">
          <div class="fdp-section-title">Chat summary</div>
          <button class="fdp-summary-period-btn" id="fdp-period-btn" onclick="cycleSummaryPeriod()">Last 24 hours</button>
          <button class="fdp-generate-btn" onclick="generateChatSummary()">Generate summary</button>
          <div class="fdp-summary-hint">Click "Generate summary" to create a summary of your chat history with this fan.</div>
          <div class="fdp-summary-result" id="fdp-summary-result"></div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ ANALYTICS ‚îÄ‚îÄ -->
    <div class="panel" id="panel-analytics">

      <!-- Header -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
        <div class="panel-title">Insights</div>
        <div style="display:flex;align-items:center;gap:10px;">
          <button class="btn-sm" onclick="loadAnalytics()" id="analytics-refresh-btn">‚Üª Refresh</button>
          <span style="font-size:12px;color:var(--text2)">GMT+7</span>
        </div>
      </div>

      <!-- Tabs -->
      <div class="a-tabs">
        <button class="a-tab active" onclick="switchAnalyticsTab('earnings')" id="atab-earnings">Earnings</button>
        <button class="a-tab" onclick="switchAnalyticsTab('monthly')" id="atab-monthly">Monthly Earnings</button>
        <button class="a-tab" onclick="switchAnalyticsTab('subscribers')" id="atab-subscribers">Subscribers</button>
      </div>

      <!-- Period pills -->
      <div class="a-period-row">
        <div class="a-period-pill" onclick="setAnalyticsPeriod('today')" id="aperiod-today">Today</div>
        <div class="a-period-pill" onclick="setAnalyticsPeriod('yesterday')" id="aperiod-yesterday">Yesterday</div>
        <div class="a-period-pill" onclick="setAnalyticsPeriod('7d')" id="aperiod-7d">Last 7 days</div>
        <div class="a-period-pill" onclick="setAnalyticsPeriod('14d')" id="aperiod-14d">Last 14 days</div>
        <div class="a-period-pill active" onclick="setAnalyticsPeriod('30d')" id="aperiod-30d">Last 30 days</div>
        <div class="a-period-pill" onclick="setAnalyticsPeriod('month')" id="aperiod-month">This month</div>
        <div class="a-period-pill" onclick="setAnalyticsPeriod('year')" id="aperiod-year">This year</div>
        <div class="a-period-pill" onclick="setAnalyticsPeriod('all')" id="aperiod-all">All time</div>
      </div>

      <!-- Stat cards row -->
      <div class="a-stat-row">
        <div class="a-stat-card">
          <div class="a-stat-card-label">Earnings <span style="color:var(--text3)">‚ìò</span></div>
          <div class="a-stat-card-value" id="a-earnings-total">‚Äî</div>
          <div class="a-stat-card-sub" id="a-earnings-sub">All time</div>
          <canvas id="chart-sparkline-total" class="a-sparkline"></canvas>
        </div>
        <div class="a-stat-card">
          <div class="a-stat-card-label">This month <span style="color:var(--text3)">‚ìò</span></div>
          <div class="a-stat-card-value" id="a-earnings-month">‚Äî</div>
          <div class="a-stat-card-sub" id="a-earnings-month-name"></div>
          <div id="a-month-vs-badge" style="display:none;" class="a-vs-badge"></div>
          <canvas id="chart-sparkline-month" class="a-sparkline"></canvas>
        </div>
        <div class="a-stat-card a-stat-promo">
          <div style="font-size:22px;margin-bottom:6px">‚≠ê</div>
          <div style="font-size:14px;font-weight:600;">You are in the top <span id="a-top-pct">‚Äî</span></div>
          <div style="font-size:12px;color:var(--text2);margin-top:4px;line-height:1.5;">Want to earn more? Checkout more suggestions for increased revenue!</div>
          <button class="a-promo-btn">Get Tips ‚Üí</button>
        </div>
      </div>

      <!-- Main 2-col grid -->
      <div class="a-main-grid">

        <!-- Left column -->
        <div class="a-col-left">

          <!-- Earnings over time chart -->
          <div class="a-card">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
              <div style="font-size:14px;font-weight:600;">Earnings over time</div>
              <div class="a-toggle">
                <button class="a-toggle-btn active" id="tog-net" onclick="setEarningsView('net')">Net</button>
                <button class="a-toggle-btn" id="tog-gross" onclick="setEarningsView('gross')">Gross</button>
              </div>
            </div>
            <canvas id="chart-earnings-time" style="max-height:220px;"></canvas>
          </div>

          <!-- Earnings breakdown table -->
          <div class="a-card">
            <div style="font-size:14px;font-weight:600;margin-bottom:4px;">Earnings breakdown</div>
            <canvas id="chart-earnings-timeline" style="max-height:100px;margin-bottom:8px;"></canvas>
            <div id="a-breakdown-table"><div class="loading">Loading...</div></div>
          </div>

          <!-- Total vs Previous comparison chart -->
          <div class="a-card">
            <div style="font-size:14px;font-weight:600;margin-bottom:16px;">Total earnings vs Previous earnings</div>
            <canvas id="chart-comparison" style="max-height:200px;"></canvas>
            <div style="display:flex;align-items:center;gap:6px;margin-top:10px;">
              <span style="width:8px;height:8px;border-radius:50%;background:#22c55e;display:inline-block;"></span>
              <span style="font-size:12px;color:var(--text2);">Total</span>
            </div>
          </div>

          <!-- Avg by day + hour -->
          <div class="a-bottom-pair">
            <div class="a-card">
              <div style="font-size:14px;font-weight:600;margin-bottom:12px;">Avg Earnings by Day</div>
              <canvas id="chart-by-day" style="max-height:200px;"></canvas>
            </div>
            <div class="a-card">
              <div style="font-size:14px;font-weight:600;margin-bottom:12px;">Avg Earnings by Time</div>
              <canvas id="chart-by-hour" style="max-height:200px;"></canvas>
            </div>
          </div>

        </div><!-- /col-left -->

        <!-- Right column -->
        <div class="a-col-right">

          <!-- Top spenders -->
          <div class="a-card">
            <div style="font-size:14px;font-weight:600;margin-bottom:12px;">Top spenders</div>
            <div id="a-top-spenders"><div class="loading">Loading...</div></div>
            <button class="a-see-more" id="a-see-more-btn" onclick="toggleAllSpenders()" style="display:none;">‚ñæ See more</button>
          </div>

          <!-- Recent transactions -->
          <div class="a-card">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
              <div style="font-size:14px;font-weight:600;">Recent transactions</div>
              <span class="a-live-badge">‚óè Live</span>
            </div>
            <div id="a-recent-tx"><div class="loading">Loading...</div></div>
          </div>

          <!-- Earnings by Type donut -->
          <div class="a-card">
            <div style="font-size:14px;font-weight:600;margin-bottom:12px;">Earnings by Type</div>
            <div style="display:flex;justify-content:center;position:relative;">
              <canvas id="chart-donut" style="max-height:180px;max-width:180px;"></canvas>
            </div>
            <div id="a-donut-legend" style="margin-top:12px;"></div>
          </div>

        </div><!-- /col-right -->

      </div><!-- /a-main-grid -->

    </div>

    <!-- ‚îÄ‚îÄ SCRIPTS ‚îÄ‚îÄ -->
    <div class="panel" id="panel-scripts">
      <div>
        <div class="panel-title">Scripts</div>
        <div class="panel-subtitle">Automation scripts for fan conversations</div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">All Scripts</div>
          <button class="btn-sm primary" onclick="loadScripts()">‚Üª Refresh</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Name</th><th>Steps</th><th>Trigger</th><th>Status</th></tr></thead>
            <tbody id="scripts-table"><tr><td colspan="4" class="loading">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ FANS ‚îÄ‚îÄ -->
    <div class="panel" id="panel-fans">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div>
          <div class="panel-title">Fans</div>
          <div class="panel-subtitle">Fan database across all accounts</div>
        </div>
        <select id="fans-acct" onchange="loadFans()" style="width:200px;">
          <option value="">Select account...</option>
        </select>
      </div>
      <div class="card">
        <div class="table-wrap">
          <table>
            <thead><tr><th>Fan</th><th>Spend 30d</th><th>Lifetime</th><th>Tier</th><th>Last Active</th></tr></thead>
            <tbody id="fans-table"><tr><td colspan="5" class="loading">Select an account</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ ACCOUNTS ‚îÄ‚îÄ -->
    <div class="panel" id="panel-accounts">
      <div>
        <div class="panel-title">Connected Accounts</div>
        <div class="panel-subtitle">Manage your Fanvue creator accounts</div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">Accounts</div>
          <button class="btn-sm primary" onclick="connectAccount()">+ Connect Account</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Account</th><th>Username</th><th>Status</th><th>Last Synced</th><th>Actions</th></tr></thead>
            <tbody id="accounts-table"><tr><td colspan="5" class="loading">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ TEAM ‚îÄ‚îÄ -->
    <div class="panel" id="panel-team">
      <div>
        <div class="panel-title">Team</div>
        <div class="panel-subtitle">Manage your agency team members</div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">Members</div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Name</th><th>Email</th><th>Role</th></tr></thead>
            <tbody id="full-team-table"><tr><td colspan="3" class="loading">Loading...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ -->
    <div class="panel" id="panel-settings">
      <div>
        <div class="panel-title">Settings</div>
        <div class="panel-subtitle">Manage your profile, security, and organization</div>
      </div>

      <!-- Tab bar -->
      <div class="settings-tabs" id="settings-tabs">
        <button class="settings-tab active" onclick="showSettingsTab('profile')">My Profile</button>
        <button class="settings-tab" onclick="showSettingsTab('security')">Security</button>
        <button class="settings-tab" id="stab-org" onclick="showSettingsTab('org')">Organization</button>
        <button class="settings-tab" id="stab-billing" onclick="showSettingsTab('billing')">Billing</button>
      </div>

      <!-- ‚îÄ‚îÄ Profile ‚îÄ‚îÄ -->
      <div class="settings-section active" id="ssec-profile">
        <div class="card">
          <div class="card-header"><div class="card-title">Profile</div></div>
          <div class="card-body" style="display:flex;flex-direction:column;gap:16px;">
            <div class="field">
              <label>Display Name</label>
              <input type="text" id="s-name" placeholder="Your name" />
            </div>
            <div class="field">
              <label>Email <span style="color:var(--text3);font-weight:400;">(cannot be changed)</span></label>
              <input type="email" id="s-email" disabled style="opacity:0.5;cursor:not-allowed;" />
            </div>
            <div class="field">
              <label>Role</label>
              <div id="s-role-badge" style="margin-top:2px;"></div>
            </div>
            <div>
              <button class="btn-primary" style="width:auto;padding:10px 24px;" onclick="saveProfile()">Save changes</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Security ‚îÄ‚îÄ -->
      <div class="settings-section" id="ssec-security">
        <div class="card">
          <div class="card-header"><div class="card-title">Change Password</div></div>
          <div class="card-body" style="display:flex;flex-direction:column;gap:16px;">
            <div class="field">
              <label>Current Password</label>
              <input type="password" id="s-cur-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
            <div class="field">
              <label>New Password</label>
              <input type="password" id="s-new-pass" placeholder="Min. 8 characters" />
            </div>
            <div class="field">
              <label>Confirm New Password</label>
              <input type="password" id="s-conf-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
            <div>
              <button class="btn-primary" style="width:auto;padding:10px 24px;" onclick="savePassword()">Update password</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Organization ‚îÄ‚îÄ -->
      <div class="settings-section" id="ssec-org">
        <div class="card">
          <div class="card-header"><div class="card-title">Organization</div></div>
          <div class="card-body" style="display:flex;flex-direction:column;gap:16px;">
            <div class="field">
              <label>Agency Name</label>
              <input type="text" id="s-org-name" placeholder="Your agency name" />
            </div>
            <div class="field">
              <label>Plan</label>
              <div id="s-plan-badge" style="margin-top:2px;"></div>
            </div>
            <div id="s-org-save-wrap">
              <button class="btn-primary" style="width:auto;padding:10px 24px;" onclick="saveOrg()">Save changes</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ Billing ‚îÄ‚îÄ -->
      <div class="settings-section" id="ssec-billing">
        <div class="card">
          <div class="card-header"><div class="card-title">Billing &amp; Plan</div></div>
          <div class="card-body" style="display:flex;flex-direction:column;gap:20px;">
            <div style="display:flex;align-items:center;justify-content:space-between;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:16px 20px;">
              <div>
                <div style="font-size:12px;color:var(--text2);font-weight:500;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">Current Plan</div>
                <div id="s-billing-plan" style="font-size:22px;font-weight:700;letter-spacing:-0.5px;">‚Äî</div>
                <div id="s-billing-member-since" style="font-size:12px;color:var(--text3);margin-top:4px;">‚Äî</div>
              </div>
              <div id="s-billing-badge"></div>
            </div>
            <div style="display:flex;flex-direction:column;gap:10px;">
              <div style="font-size:13px;font-weight:600;">Plan features</div>
              <div id="s-plan-features" style="display:flex;flex-direction:column;gap:8px;"></div>
            </div>
            <div style="border-top:1px solid var(--border);padding-top:16px;">
              <button class="btn-primary" style="width:100%;padding:12px;" onclick="toast('Contact us to upgrade your plan','info')">Upgrade Plan ‚Üí</button>
              <div style="font-size:12px;color:var(--text3);text-align:center;margin-top:8px;">Contact support to change your plan</div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /main -->
</div><!-- /app -->

<div id="toast-wrap"></div>

<script>
const API = '';  // same origin
let token = localStorage.getItem('fd_token') || '';
let currentUser = null;
let accounts = [];
let inboxFilter = 'all';
let inboxConvos = [];
let activeConvoId = null;
let activeFanId = null;
let activeConvoData = null;
let nicknameEditMode = false;
let summaryPeriods = ['Last 24 hours', 'Last 7 days', 'Last 30 days'];
let currentSummaryPeriod = 0;
let activeNoteFilter = 'all';

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function api(path, opts = {}) {
  const res = await fetch(API + path, {
    ...opts,
    headers: {
      'Content-Type': 'application/json',
      ...(token ? { Authorization: `Bearer ${token}` } : {}),
      ...(opts.headers || {})
    },
    body: opts.body ? JSON.stringify(opts.body) : undefined
  });
  const data = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
  return data;
}

function toast(msg, type = 'info') {
  const el = document.createElement('div');
  el.className = `toast toast-${type}`;
  el.textContent = msg;
  document.getElementById('toast-wrap').appendChild(el);
  setTimeout(() => el.remove(), 3500);
}

function fmt(n) {
  if (n == null) return '‚Äî';
  if (n >= 1e6) return '$' + (n/1e6).toFixed(2) + 'M';
  if (n >= 1e3) return '$' + (n/1e3).toFixed(1) + 'K';
  return '$' + Number(n).toFixed(2);
}

function fmtNum(n) {
  if (n == null) return '‚Äî';
  if (n >= 1e6) return (n/1e6).toFixed(1) + 'M';
  if (n >= 1e3) return (n/1e3).toFixed(1) + 'K';
  return String(n);
}

function timeAgo(ts) {
  if (!ts) return '‚Äî';
  const secs = Math.floor((Date.now() - new Date(ts)) / 1000);
  if (secs < 60) return 'just now';
  if (secs < 3600) return Math.floor(secs/60) + 'm ago';
  if (secs < 86400) return Math.floor(secs/3600) + 'h ago';
  return Math.floor(secs/86400) + 'd ago';
}

function shortTime(ts) {
  if (!ts) return '';
  const d = new Date(ts);
  const now = new Date();
  const isToday = d.toDateString() === now.toDateString();
  if (isToday) return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  return d.toLocaleDateString([], { month: 'short', day: 'numeric' });
}

function fmtDate(ts) {
  if (!ts) return '‚Äî';
  return new Date(ts).toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });
}

function monthsAgo(ts) {
  if (!ts) return null;
  const start = new Date(ts);
  const now = new Date();
  const months = (now.getFullYear() - start.getFullYear()) * 12 + (now.getMonth() - start.getMonth());
  if (months <= 0) return 'This month';
  if (months === 1) return '1 month ago';
  return months + ' months ago';
}

// ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let isSignup = false;
function toggleAuth() {
  isSignup = !isSignup;
  document.getElementById('signup-fields').style.display = isSignup ? 'flex' : 'none';
  document.getElementById('auth-title').textContent = isSignup ? 'Create your account' : 'Welcome back';
  document.getElementById('auth-btn').textContent = isSignup ? 'Create Account' : 'Sign In';
  document.getElementById('auth-toggle').innerHTML = isSignup
    ? 'Already have an account? <a onclick="toggleAuth()">Sign in</a>'
    : 'Don\'t have an account? <a onclick="toggleAuth()">Create one</a>';
  document.getElementById('auth-err').style.display = 'none';
}

async function authSubmit() {
  const btn = document.getElementById('auth-btn');
  const errEl = document.getElementById('auth-err');
  const email = document.getElementById('f-email').value.trim();
  const pass = document.getElementById('f-pass').value;
  errEl.style.display = 'none';
  if (!email || !pass) { errEl.textContent = 'Email and password required'; errEl.style.display = 'block'; return; }
  btn.disabled = true;
  btn.textContent = 'Loading...';
  try {
    let data;
    if (isSignup) {
      const name = document.getElementById('f-name').value.trim();
      const agencyName = document.getElementById('f-agency').value.trim();
      if (!name || !agencyName) throw new Error('All fields required');
      data = await api('/api/auth/signup', { method: 'POST', body: { name, email, password: pass, agencyName } });
    } else {
      data = await api('/api/auth/login', { method: 'POST', body: { email, password: pass } });
    }
    token = data.token;
    localStorage.setItem('fd_token', token);
    currentUser = data.user;
    initApp();
  } catch (e) {
    errEl.textContent = e.message;
    errEl.style.display = 'block';
  } finally {
    btn.disabled = false;
    btn.textContent = isSignup ? 'Create Account' : 'Sign In';
  }
}

function logout() {
  token = '';
  currentUser = null;
  accounts = [];
  localStorage.removeItem('fd_token');
  document.getElementById('app').style.display = 'none';
  document.getElementById('auth-screen').style.display = 'flex';
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function initApp() {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  if (!currentUser) {
    try { const d = await api('/api/auth/me'); currentUser = d.user; } catch(e) { logout(); return; }
  }
  document.getElementById('user-name').textContent = currentUser.name;
  document.getElementById('user-role').textContent = currentUser.role;
  document.getElementById('user-avatar').textContent = currentUser.name?.[0]?.toUpperCase() || '?';
  loadDashboard();
}

// ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPanel(name) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('panel-' + name).classList.add('active');
  document.getElementById('nav-' + name).classList.add('active');
  if (name === 'analytics') loadAnalytics();
  if (name === 'scripts') loadScripts();
  if (name === 'accounts') loadAccountsPanel();
  if (name === 'team') loadFullTeam();
  if (name === 'settings') loadSettings();
}

// ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let ovPeriod = 'today';
const ovPeriodLabels = { today:'Today', yesterday:'Yesterday', '7d':'Last 7 days', '14d':'Last 14 days', '30d':'Last 30 days', month:'This month', year:'This year', all:'All time' };

function getGreeting() {
  const h = new Date().getHours();
  if (h < 12) return 'morning';
  if (h < 17) return 'afternoon';
  return 'evening';
}

function setOvPeriod(p) {
  ovPeriod = p;
  document.querySelectorAll('#ov-period-row .a-period-pill').forEach(el => el.classList.remove('active'));
  const pill = document.getElementById('ovp-' + p);
  if (pill) pill.classList.add('active');
  loadOverviewAnalytics();
}

async function loadDashboard() {
  try {
    const d = await api('/api/dashboard');
    document.getElementById('org-name').textContent = d.org?.name || 'Your Agency';
    const firstName = (currentUser.name || '').split(' ')[0] || 'there';
    document.getElementById('overview-greeting').textContent = `Good ${getGreeting()}, ${firstName} üëã`;
    document.getElementById('overview-sub').textContent = d.org?.name || 'Your agency dashboard';
    document.getElementById('ov-accts').textContent = d.accounts?.active ?? '‚Äî';
    document.getElementById('ov-team-sub').textContent = `${d.team?.total ?? 0} team member${d.team?.total === 1 ? '' : 's'}`;

    accounts = d.accounts?.all || [];
    populateAcctSelects();

    // Populate per-overview widget account selectors
    const activeAccounts = accounts.filter(a => a.is_active);
    ['ov-spenders-acct', 'ov-tx-acct'].forEach(selId => {
      const sel = document.getElementById(selId);
      if (!sel) return;
      sel.innerHTML = activeAccounts.map(a => `<option value="${a.id}">${a.label || a.fanvue_username}</option>`).join('');
    });

    // Team widget
    const team = d.team?.members || [];
    document.getElementById('ov-team').innerHTML = team.length
      ? team.map(u => `
        <div style="display:flex;align-items:center;gap:10px;padding:8px 14px;border-bottom:1px solid var(--border);">
          <div class="user-avatar" style="flex-shrink:0;width:30px;height:30px;font-size:11px;">${(u.name||'?')[0].toUpperCase()}</div>
          <div style="flex:1;min-width:0;">
            <div style="font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${u.name}</div>
            <div style="font-size:11px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${u.email}</div>
          </div>
          ${roleBadge(u.role)}
        </div>`).join('')
      : '<div class="empty">No team members</div>';

    // Inbox unread badge
    const unreadCount = accounts.reduce((a, b) => a + (b.unread_count || 0), 0);
    const badge = document.getElementById('inbox-badge');
    badge.style.display = unreadCount ? 'inline' : 'none';
    badge.textContent = unreadCount;

    // Load analytics (earnings, subs, per-account cards)
    await loadOverviewAnalytics();

  } catch (e) {
    toast(e.message, 'error');
  }
}

async function loadOverviewAnalytics() {
  const label = ovPeriodLabels[ovPeriod] || ovPeriod;
  ['ov-earn', 'ov-subs', 'ov-new-subs'].forEach(id => { document.getElementById(id).textContent = '‚Äî'; });
  document.getElementById('ov-earn-sub').textContent = label;
  document.getElementById('ov-new-sub-label').textContent = label;
  document.getElementById('ov-account-cards').innerHTML = '<div class="loading">Loading...</div>';

  try {
    const d = await api(`/api/analytics/overview?period=${ovPeriod}`);
    document.getElementById('ov-earn').textContent = fmt(d.totals?.earnings);
    document.getElementById('ov-subs').textContent = fmtNum(d.totals?.subscribers);
    document.getElementById('ov-new-subs').textContent = fmtNum(d.totals?.newSubscribers);

    const acctCards = document.getElementById('ov-account-cards');
    if (!d.accounts?.length) {
      acctCards.innerHTML = '<div class="empty">No active accounts connected</div>';
    } else {
      acctCards.innerHTML = d.accounts.map(a => {
        const initials = (a.label || a.fanvue_username || '?')[0].toUpperCase();
        const avatarInner = a.avatar_url
          ? `<img src="${a.avatar_url}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;" onerror="this.style.display='none';">`
          : initials;
        return `
        <div class="ov-acct-card">
          <div class="ov-acct-avatar">${avatarInner}</div>
          <div class="ov-acct-info">
            <div class="ov-acct-name">${a.label || a.fanvue_username}</div>
            <div class="ov-acct-handle">@${a.fanvue_username || ''}</div>
            <div class="ov-acct-stats">
              <div class="ov-acct-stat">
                <div class="ov-acct-stat-val" style="color:var(--green);">${fmt(a.earnings)}</div>
                <div class="ov-acct-stat-lbl">${label}</div>
              </div>
              <div class="ov-acct-stat">
                <div class="ov-acct-stat-val">${fmtNum(a.subscriberCount)}</div>
                <div class="ov-acct-stat-lbl">Subscribers</div>
              </div>
              <div class="ov-acct-stat">
                <div class="ov-acct-stat-val">${fmtNum(a.newSubscribers)}</div>
                <div class="ov-acct-stat-lbl">New ${label}</div>
              </div>
            </div>
          </div>
          <div class="ov-acct-actions">
            <button class="btn-sm primary" onclick="showPanel('analytics')">Analytics ‚Üí</button>
            <button class="btn-sm" onclick="showPanel('inbox')">Inbox</button>
          </div>
        </div>`;
      }).join('');
    }
  } catch (e) {
    document.getElementById('ov-account-cards').innerHTML = '<div class="empty">Failed to load data</div>';
    console.error('[Overview] analytics error:', e.message);
  }

  loadOvTopSpenders();
  loadOvTransactions();
}

async function loadOvTopSpenders() {
  const sel = document.getElementById('ov-spenders-acct');
  const acctId = sel?.value;
  if (!acctId) return;
  const el = document.getElementById('ov-top-spenders');
  el.innerHTML = '<div class="loading">Loading...</div>';
  try {
    const d = await api(`/api/analytics/${acctId}/top-spenders?size=8`);
    if (!d.data?.length) { el.innerHTML = '<div class="empty">No spenders yet</div>'; return; }
    el.innerHTML = d.data.slice(0, 8).map((f, i) => {
      const initials = (f.display_name || f.username || '?')[0]?.toUpperCase() || '?';
      const avatarEl = f.avatar_url
        ? `<img src="${f.avatar_url}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;border:1px solid var(--border);flex-shrink:0;" onerror="this.style.display='none';">`
        : `<div class="a-avatar sm" style="flex-shrink:0;">${initials}</div>`;
      return `
      <div class="a-spender-row" style="padding:9px 14px;">
        <div style="font-size:12px;color:var(--text3);width:18px;text-align:right;flex-shrink:0;">${i + 1}</div>
        ${avatarEl}
        <div style="flex:1;min-width:0;">
          <div style="font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${f.display_name || f.username || 'Fan'}</div>
          ${f.username ? `<div style="font-size:11px;color:var(--text3);">@${f.username}</div>` : ''}
        </div>
        <div style="font-size:13px;font-weight:700;color:var(--green);flex-shrink:0;">${fmt(f.gross || f.net || 0)}</div>
      </div>`;
    }).join('');
  } catch (e) {
    el.innerHTML = '<div class="empty">Failed to load</div>';
  }
}

async function loadOvTransactions() {
  const sel = document.getElementById('ov-tx-acct');
  const acctId = sel?.value;
  if (!acctId) return;
  const el = document.getElementById('ov-recent-tx');
  el.innerHTML = '<div class="loading">Loading...</div>';
  const sourceColors = { subscription: 'var(--accent)', tip: 'var(--green)', ppv: 'var(--orange)', message: 'var(--blue)' };
  const sourceLabels = { subscription: 'Sub', tip: 'Tip', ppv: 'PPV', message: 'Msg' };
  try {
    const d = await api(`/api/analytics/${acctId}/earnings?period=30d`);
    const txs = (d.data || [])
      .sort((a, b) => new Date(b.createdAt || b.created_at || 0) - new Date(a.createdAt || a.created_at || 0))
      .slice(0, 12);
    if (!txs.length) { el.innerHTML = '<div class="empty">No transactions</div>'; return; }
    el.innerHTML = txs.map(tx => {
      const src = tx.source || 'other';
      const color = sourceColors[src] || 'var(--text2)';
      const srcLabel = sourceLabels[src] || src;
      const ts = tx.createdAt || tx.created_at;
      const fanName = tx.user?.displayName || tx.user?.handle || tx.fan_display_name || tx.fan_username || '';
      return `
      <div class="a-tx-row">
        <div style="width:36px;height:36px;border-radius:10px;background:var(--bg3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:${color};flex-shrink:0;">${srcLabel[0]}</div>
        <div class="a-tx-info" style="flex:1;">
          <div style="font-size:13px;color:var(--text);font-weight:500;">${srcLabel}</div>
          ${fanName ? `<div style="font-size:11px;color:var(--text3);">from ${fanName}</div>` : ''}
        </div>
        <div style="text-align:right;flex-shrink:0;">
          <div style="font-size:13px;font-weight:700;color:${color};">+${fmt(tx.gross || 0)}</div>
          <div style="font-size:11px;color:var(--text3);">${timeAgo(ts)}</div>
        </div>
      </div>`;
    }).join('');
  } catch (e) {
    el.innerHTML = '<div class="empty">Failed to load</div>';
  }
}

function roleBadge(role) {
  const map = { owner: 'badge-purple', manager: 'badge-blue', chatter: 'badge-orange' };
  return `<span class="badge ${map[role]||'badge-gray'}">${role}</span>`;
}

// ‚îÄ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const planFeatures = {
  starter: ['Up to 3 connected accounts', 'Inbox & messaging', 'Basic analytics', 'Team up to 3 members'],
  pro:     ['Up to 10 connected accounts', 'Full analytics & insights', 'Top spenders tracking', 'Team up to 10 members', 'Priority support'],
  agency:  ['Unlimited connected accounts', 'Full analytics & insights', 'Top spenders tracking', 'Unlimited team members', 'Dedicated account manager', 'Custom integrations']
};

async function loadSettings() {
  try {
    const { user, org } = await api('/api/settings');

    // Profile tab
    document.getElementById('s-name').value = user.name || '';
    document.getElementById('s-email').value = user.email || '';
    document.getElementById('s-role-badge').innerHTML = roleBadge(user.role);

    // Org tab ‚Äî hide save button + name input for non-owners
    document.getElementById('s-org-name').value = org.name || '';
    const isOwner = user.role === 'owner';
    const isManager = user.role === 'manager';
    document.getElementById('s-org-name').disabled = !isOwner;
    if (!isOwner) document.getElementById('s-org-name').style.opacity = '0.5';
    document.getElementById('s-org-save-wrap').style.display = isOwner ? '' : 'none';

    // Hide Org + Billing tabs for chatters
    document.getElementById('stab-org').style.display = (isOwner || isManager) ? '' : 'none';
    document.getElementById('stab-billing').style.display = isOwner ? '' : 'none';

    // Plan badge
    const plan = org.plan || 'starter';
    const planClass = { starter: 's-plan-starter', pro: 's-plan-pro', agency: 's-plan-agency' }[plan] || 's-plan-starter';
    const planLabel = plan.charAt(0).toUpperCase() + plan.slice(1);
    document.getElementById('s-plan-badge').innerHTML = `<span class="s-plan-pill ${planClass}">${planLabel}</span>`;

    // Billing tab
    document.getElementById('s-billing-plan').textContent = planLabel;
    document.getElementById('s-billing-badge').innerHTML = `<span class="s-plan-pill ${planClass}" style="font-size:13px;">${planLabel}</span>`;
    const since = org.created_at ? `Member since ${new Date(org.created_at).toLocaleDateString([], { month: 'long', year: 'numeric' })}` : '';
    document.getElementById('s-billing-member-since').textContent = since;
    const features = planFeatures[plan] || planFeatures.starter;
    document.getElementById('s-plan-features').innerHTML = features.map(f =>
      `<div class="s-feature-row"><span class="s-feature-check">‚úì</span>${f}</div>`
    ).join('');

  } catch (e) {
    toast(e.message, 'error');
  }
}

function showSettingsTab(tab) {
  document.querySelectorAll('.settings-tab').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.settings-section').forEach(el => el.classList.remove('active'));
  // Match button by onclick attribute pattern
  document.querySelectorAll('.settings-tab').forEach(el => {
    if (el.getAttribute('onclick') === `showSettingsTab('${tab}')`) el.classList.add('active');
  });
  document.getElementById(`ssec-${tab}`)?.classList.add('active');
}

async function saveProfile() {
  const name = document.getElementById('s-name').value.trim();
  if (!name) { toast('Name cannot be empty', 'error'); return; }
  try {
    await api('/api/settings/profile', { method: 'PATCH', body: { name } });
    currentUser.name = name;
    document.getElementById('user-name').textContent = name;
    document.getElementById('overview-greeting').textContent = `Good ${getGreeting()}, ${name.split(' ')[0]} üëã`;
    toast('Profile updated', 'success');
  } catch (e) {
    toast(e.message, 'error');
  }
}

async function savePassword() {
  const currentPassword = document.getElementById('s-cur-pass').value;
  const newPassword     = document.getElementById('s-new-pass').value;
  const confirmPassword = document.getElementById('s-conf-pass').value;
  if (!currentPassword || !newPassword || !confirmPassword) { toast('All password fields are required', 'error'); return; }
  if (newPassword !== confirmPassword) { toast('New passwords do not match', 'error'); return; }
  if (newPassword.length < 8) { toast('Password must be at least 8 characters', 'error'); return; }
  try {
    await api('/api/settings/password', { method: 'PATCH', body: { currentPassword, newPassword } });
    document.getElementById('s-cur-pass').value = '';
    document.getElementById('s-new-pass').value = '';
    document.getElementById('s-conf-pass').value = '';
    toast('Password updated successfully', 'success');
  } catch (e) {
    toast(e.message, 'error');
  }
}

async function saveOrg() {
  const name = document.getElementById('s-org-name').value.trim();
  if (!name) { toast('Organization name cannot be empty', 'error'); return; }
  try {
    await api('/api/settings/organization', { method: 'PATCH', body: { name } });
    document.getElementById('org-name').textContent = name;
    document.getElementById('overview-sub').textContent = name;
    toast('Organization updated', 'success');
  } catch (e) {
    toast(e.message, 'error');
  }
}

// ‚îÄ‚îÄ‚îÄ ACCOUNTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function populateAcctSelects() {
  populateAcctSelect('inbox-acct');
}

function populateAcctSelect(selectId) {
  const sel = document.getElementById(selectId);
  if (!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">Select account...</option>' +
    accounts.filter(a => a.is_active).map(a => `<option value="${a.id}">${a.label || a.fanvue_display_name || a.fanvue_username}</option>`).join('');
  if (cur) sel.value = cur;
}

async function loadAccountsPanel() {
  try {
    const d = await api('/api/accounts');
    accounts = d.accounts || d || [];
    const tbody = document.getElementById('accounts-table');
    if (!accounts.length) {
      tbody.innerHTML = '<tr><td colspan="5" class="empty">No accounts connected. Click "+  Connect Account" to add one.</td></tr>';
      return;
    }
    tbody.innerHTML = accounts.map(a => `
      <tr>
        <td><div style="display:flex;align-items:center;gap:8px;">
          ${a.avatar_url ? `<img src="${a.avatar_url}" style="width:28px;height:28px;border-radius:50%;object-fit:cover;">` : `<div style="width:28px;height:28px;border-radius:50%;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:11px;">${(a.label||'?')[0]}</div>`}
          <span style="font-weight:500">${a.label || a.fanvue_display_name || '‚Äî'}</span>
        </div></td>
        <td style="color:var(--text2)">@${a.fanvue_username||'‚Äî'}</td>
        <td>${a.needs_reconnect ? '<span class="badge badge-red">Needs reconnect</span>' : a.is_active ? '<span class="badge badge-green">Active</span>' : '<span class="badge badge-gray">Inactive</span>'}</td>
        <td style="color:var(--text2)">${timeAgo(a.last_synced)}</td>
        <td>
          ${a.needs_reconnect ? `<button class="btn-sm" onclick="reconnectAccount('${a.id}')">Reconnect</button>` : ''}
          <button class="btn-sm" onclick="syncAccount('${a.id}')">Sync</button>
        </td>
      </tr>`).join('');
  } catch (e) {
    toast('Failed to load accounts: ' + e.message, 'error');
  }
}

function connectAccount() {
  window.location.href = '/api/oauth/connect';
}

async function syncAccount(id) {
  try {
    toast('Syncing inbox...', 'info');
    await api(`/api/conversations/sync/${id}`, { method: 'POST' });
    toast('Sync initiated', 'success');
  } catch (e) {
    toast('Sync failed: ' + e.message, 'error');
  }
}

async function reconnectAccount(id) {
  window.location.href = `/api/oauth/connect?accountId=${id}`;
}

// ‚îÄ‚îÄ‚îÄ ANALYTICS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ‚îÄ ANALYTICS (redesigned) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let analyticsView = 'net';
let analyticsCharts = {};
let analyticsAllSpenders = [];
let analyticsShowAll = false;
let analyticsPeriod = '30d';
let analyticsEarningsData = null;

function setAnalyticsPeriod(period) {
  analyticsPeriod = period;
  document.querySelectorAll('.a-period-pill').forEach(el => el.classList.remove('active'));
  const el = document.getElementById('aperiod-' + period);
  if (el) el.classList.add('active');
  loadAnalytics();
}

function switchAnalyticsTab(tab) {
  document.querySelectorAll('.a-tab').forEach(el => el.classList.remove('active'));
  const el = document.getElementById('atab-' + tab);
  if (el) el.classList.add('active');
  loadAnalytics();
}

function setEarningsView(view) {
  analyticsView = view;
  document.getElementById('tog-net').classList.toggle('active', view === 'net');
  document.getElementById('tog-gross').classList.toggle('active', view === 'gross');
  if (analyticsEarningsData) {
    renderEarningsTimeChart(analyticsEarningsData);
    renderComparisonChart(analyticsEarningsData);
    renderSparklines(analyticsEarningsData);
  }
}

function toggleAllSpenders() {
  analyticsShowAll = !analyticsShowAll;
  renderTopSpenders(analyticsAllSpenders);
}

function destroyCharts() {
  Object.values(analyticsCharts).forEach(c => { try { c.destroy(); } catch(e) {} });
  analyticsCharts = {};
}

async function loadAnalytics() {
  destroyCharts();
  document.getElementById('a-earnings-total').textContent = '‚Äî';
  document.getElementById('a-earnings-month').textContent = '‚Äî';
  document.getElementById('a-month-vs-badge').style.display = 'none';
  document.getElementById('a-top-spenders').innerHTML = '<div class="loading">Loading...</div>';
  document.getElementById('a-recent-tx').innerHTML = '<div class="loading">Loading...</div>';
  document.getElementById('a-breakdown-table').innerHTML = '<div class="loading">Loading...</div>';
  document.getElementById('a-donut-legend').innerHTML = '';
  document.getElementById('a-top-pct').textContent = '‚Äî';

  const period = analyticsPeriod;

  try {
    const overview = await api(`/api/analytics/overview?period=${period}`);
    const totals = overview.totals;

    document.getElementById('a-earnings-total').textContent = fmt(totals.earnings);
    const periodLabels = { today: 'Today', yesterday: 'Yesterday', '7d': 'Last 7 days', '14d': 'Last 14 days', '30d': 'Last 30 days', month: 'This month', year: 'This year', all: 'All time' };
    document.getElementById('a-earnings-sub').textContent = periodLabels[period] || ('Last ' + period);

    const now = new Date();
    document.getElementById('a-earnings-month-name').textContent =
      now.toLocaleString('default', { month: 'long', year: 'numeric' });

    if (!overview.accounts || !overview.accounts.length) {
      document.getElementById('a-earnings-month').textContent = '‚Äî';
      ['a-top-spenders','a-recent-tx','a-breakdown-table'].forEach(id => {
        document.getElementById(id).innerHTML = '<div class="empty">No accounts connected</div>';
      });
      return;
    }

    const acct = overview.accounts[0];
    const accountId = acct.accountId;

    const [earningsRes, spendersRes] = await Promise.allSettled([
      api(`/api/analytics/${accountId}/earnings?period=${period}`),
      api(`/api/analytics/${accountId}/top-spenders?page=1&size=20`)
    ]);

    if (earningsRes.status === 'fulfilled') {
      const ed = earningsRes.value;
      analyticsEarningsData = ed.data || [];

      // This month total
      const thisMonth = analyticsEarningsData.filter(tx => {
        const d = new Date(tx.date || tx.created_at || tx.createdAt || 0);
        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
      });
      const monthTotal = thisMonth.reduce((s, t) => s + (t[analyticsView] || t.net || 0), 0);
      document.getElementById('a-earnings-month').textContent = fmt(monthTotal);

      // vs prev month badge
      const prevMonthDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      const prevMonth = analyticsEarningsData.filter(tx => {
        const d = new Date(tx.date || tx.created_at || tx.createdAt || 0);
        return d.getMonth() === prevMonthDate.getMonth() && d.getFullYear() === prevMonthDate.getFullYear();
      });
      const prevTotal = prevMonth.reduce((s, t) => s + (t[analyticsView] || t.net || 0), 0);
      if (monthTotal > 0 || prevTotal > 0) {
        const diff = monthTotal - prevTotal;
        const badge = document.getElementById('a-month-vs-badge');
        badge.style.display = 'inline-flex';
        badge.style.background = diff >= 0 ? 'rgba(34,197,94,0.15)' : 'rgba(239,68,68,0.15)';
        badge.style.color = diff >= 0 ? '#22c55e' : '#ef4444';
        const prevName = prevMonthDate.toLocaleString('default', { month: 'short' });
        badge.textContent = (diff >= 0 ? '+' : '') + fmt(diff) + ' vs ' + prevName;
      }

      renderEarningsTimeChart(analyticsEarningsData);
      renderBreakdownTable(ed.breakdown || {}, ed.total || 0);
      renderRecentTransactions(analyticsEarningsData);
      renderDonutChart(ed.breakdown || {});
      renderComparisonChart(analyticsEarningsData);
      renderByDayChart(analyticsEarningsData);
      renderByHourChart(analyticsEarningsData);
      renderSparklines(analyticsEarningsData);
    } else {
      ['a-recent-tx','a-breakdown-table'].forEach(id => {
        document.getElementById(id).innerHTML = '<div class="empty">Could not load earnings data</div>';
      });
    }

    if (spendersRes.status === 'fulfilled') {
      analyticsAllSpenders = spendersRes.value.data || [];
      analyticsShowAll = false;
      renderTopSpenders(analyticsAllSpenders);
    } else {
      document.getElementById('a-top-spenders').innerHTML = '<div class="empty">No data</div>';
    }

  } catch (e) {
    toast('Analytics error: ' + e.message, 'error');
    console.error('[Analytics]', e);
  }
}

function renderTopSpenders(data) {
  const el = document.getElementById('a-top-spenders');
  const btn = document.getElementById('a-see-more-btn');
  const visible = analyticsShowAll ? data : data.slice(0, 3);
  if (!data.length) {
    el.innerHTML = '<div class="empty">No spenders yet</div>';
    if (btn) btn.style.display = 'none';
    return;
  }
  el.innerHTML = visible.map(f => {
    const name = f.display_name || f.username || f.fan_username || f.fan?.display_name || 'Unknown';
    const initials = name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
    const amount = fmt(f.gross || f.net || 0);
    return `<div class="a-spender-row">
      <div class="a-avatar">${initials}</div>
      <div style="flex:1;font-size:13px;font-weight:500;">${name}</div>
      <div style="font-size:14px;font-weight:700;">${amount}</div>
    </div>`;
  }).join('');
  if (btn) {
    btn.style.display = data.length > 3 ? 'block' : 'none';
    btn.innerHTML = analyticsShowAll ? '‚ñ¥ Show less' : '‚ñæ See more';
  }
}

function renderRecentTransactions(data) {
  const el = document.getElementById('a-recent-tx');
  const sorted = [...data].sort((a, b) => {
    return new Date(b.date || b.created_at || b.createdAt || 0) - new Date(a.date || a.created_at || a.createdAt || 0);
  });
  const recent = sorted.slice(0, 6);
  if (!recent.length) { el.innerHTML = '<div class="empty">No transactions</div>'; return; }
  const srcLabel = { message:'purchased a message', subscription:'subscribed to your feed',
    renewal:'renewed their subscription', tip:'sent a tip', post:'purchased a post',
    referral:'referred a new fan', giveaway:'received a giveaway' };
  el.innerHTML = recent.map(tx => {
    const name = tx.fan_display_name || tx.fan_username || tx.fan?.display_name || tx.fan?.username || 'Fan';
    const initials = name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
    const src = tx.source || 'transaction';
    const label = srcLabel[src] || src;
    const amount = fmt(tx.net || tx.gross || 0);
    const ago = timeAgo(tx.date || tx.created_at || tx.createdAt);
    return `<div class="a-tx-row">
      <div class="a-avatar sm">${initials}</div>
      <div class="a-tx-info">
        <strong>${name}</strong> ${label}
        <div class="a-tx-amount">${amount}</div>
      </div>
      <div class="a-tx-time">${ago}</div>
    </div>`;
  }).join('');
}

function renderBreakdownTable(breakdown, total) {
  const el = document.getElementById('a-breakdown-table');
  const colors = { subscription:'#3b82f6', message:'#f97316', post:'#a855f7',
    tip:'#ec4899', renewal:'#eab308', referral:'#06b6d4', other:'#6b7280', giveaway:'#22c55e' };
  const labels = { subscription:'Subs', message:'Messages', post:'Posts',
    tip:'Tips', renewal:'Renewals', referral:'Referrals', other:'Other', giveaway:'Giveaway' };
  const entries = Object.entries(breakdown).filter(([,v]) => v >= 0);
  const rows = [['__total__','Total', total, true], ...entries.map(([k,v]) => [k, labels[k]||k, v, false])];
  el.innerHTML = rows.map(([key, label, amount, isTotal]) => {
    const color = isTotal ? '#22c55e' : (colors[key] || '#6b7280');
    const badge = isTotal && amount > 0 ? `<span class="a-brow-badge">+${fmt(amount)}</span>` : '';
    return `<div class="a-brow">
      <span class="a-brow-dot" style="background:${color}"></span>
      <span class="a-brow-label">${label}</span>
      <span class="a-brow-amount">${fmt(amount)}</span>
      ${badge}
    </div>`;
  }).join('');
}

function renderDonutChart(breakdown) {
  const ctx = document.getElementById('chart-donut');
  if (!ctx) return;
  const colors = ['#f97316','#ec4899','#a855f7','#3b82f6','#eab308','#06b6d4','#22c55e','#6b7280'];
  const entries = Object.entries(breakdown).filter(([,v]) => v > 0);
  if (!entries.length) return;
  const labels = entries.map(([k]) => k);
  const data = entries.map(([,v]) => v);
  const total = data.reduce((s, v) => s + v, 0);
  if (analyticsCharts['donut']) analyticsCharts['donut'].destroy();
  analyticsCharts['donut'] = new Chart(ctx, {
    type: 'doughnut',
    data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0, hoverOffset: 6 }] },
    options: {
      cutout: '72%',
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: c => ` ${c.label}: ${fmt(c.raw)}` } }
      }
    }
  });
  const labelMap = { subscription:'Subs', message:'Messages', post:'Posts',
    tip:'Tips', renewal:'Renewals', referral:'Referrals', other:'Other', giveaway:'Giveaway' };
  const legendEl = document.getElementById('a-donut-legend');
  legendEl.innerHTML = entries.map(([k, v], i) => {
    const pct = total > 0 ? v / total : 0;
    return `<div class="a-donut-legend-row">
      <span class="a-donut-legend-dot" style="background:${colors[i % colors.length]}"></span>
      <span class="a-donut-legend-label">${labelMap[k]||k}</span>
      <div class="a-donut-legend-bar"><div class="a-donut-legend-bar-fill" style="width:${(pct*100).toFixed(0)}%;background:${colors[i % colors.length]};"></div></div>
      <span class="a-donut-legend-amount">${fmt(v)}</span>
    </div>`;
  }).join('');
}

function buildDailyTotals(data, field) {
  const byDate = {};
  data.forEach(tx => {
    const raw = tx.date || tx.created_at || tx.createdAt;
    if (!raw) return;
    const d = new Date(raw).toISOString().split('T')[0];
    byDate[d] = (byDate[d] || 0) + (tx[field] || 0);
  });
  const sorted = Object.entries(byDate).sort(([a], [b]) => a.localeCompare(b));
  return { labels: sorted.map(([d]) => d), values: sorted.map(([,v]) => v) };
}

const CHART_DEFAULTS = {
  responsive: true, maintainAspectRatio: true,
  plugins: { legend: { display: false } },
  scales: {
    x: { grid: { color: 'rgba(255,255,255,0.04)' }, ticks: { color: '#606070', maxTicksLimit: 8, font: { size: 11 } } },
    y: { grid: { color: 'rgba(255,255,255,0.04)', borderDash: [4,4] }, ticks: { color: '#606070', font: { size: 11 }, callback: v => '$' + v } }
  }
};

function renderEarningsTimeChart(data) {
  const ctx = document.getElementById('chart-earnings-time');
  if (!ctx) return;
  const { labels, values } = buildDailyTotals(data, analyticsView);
  if (analyticsCharts['earnings-time']) analyticsCharts['earnings-time'].destroy();
  analyticsCharts['earnings-time'] = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ data: values, borderColor: '#6366f1', backgroundColor: 'rgba(99,102,241,0.08)',
      fill: true, tension: 0.3, pointRadius: 0, pointHoverRadius: 4, borderWidth: 2 }] },
    options: { ...CHART_DEFAULTS, plugins: { ...CHART_DEFAULTS.plugins,
      tooltip: { callbacks: { label: c => ` ${fmt(c.raw)}` } } } }
  });
}

function renderComparisonChart(data) {
  const ctx = document.getElementById('chart-comparison');
  if (!ctx) return;
  const { labels, values } = buildDailyTotals(data, analyticsView);
  if (analyticsCharts['comparison']) analyticsCharts['comparison'].destroy();
  analyticsCharts['comparison'] = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label: 'Total', data: values, borderColor: '#22c55e',
      backgroundColor: 'rgba(34,197,94,0.05)', fill: true, tension: 0.3,
      pointRadius: 0, borderWidth: 2 }] },
    options: { ...CHART_DEFAULTS, plugins: { ...CHART_DEFAULTS.plugins,
      tooltip: { callbacks: { label: c => ` ${fmt(c.raw)}` } } } }
  });
}

function renderByDayChart(data) {
  const ctx = document.getElementById('chart-by-day');
  if (!ctx) return;
  const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const totals = new Array(7).fill(0);
  const counts = new Array(7).fill(0);
  data.forEach(tx => {
    const raw = tx.date || tx.created_at || tx.createdAt;
    if (!raw) return;
    const dow = (new Date(raw).getDay() + 6) % 7;
    totals[dow] += tx[analyticsView] || tx.net || 0;
    counts[dow]++;
  });
  const avgs = totals.map((t, i) => counts[i] > 0 ? +(t / counts[i]).toFixed(2) : 0);
  if (analyticsCharts['by-day']) analyticsCharts['by-day'].destroy();
  analyticsCharts['by-day'] = new Chart(ctx, {
    type: 'bar',
    data: { labels: days, datasets: [{ data: avgs, backgroundColor: '#ffffff', borderRadius: 4, borderSkipped: false }] },
    options: { ...CHART_DEFAULTS, scales: { ...CHART_DEFAULTS.scales,
      x: { ...CHART_DEFAULTS.scales.x, grid: { display: false } } },
      plugins: { ...CHART_DEFAULTS.plugins, tooltip: { callbacks: { label: c => ` ${fmt(c.raw)}` } } } }
  });
}

function renderByHourChart(data) {
  const ctx = document.getElementById('chart-by-hour');
  if (!ctx) return;
  const hourLabels = Array.from({ length: 24 }, (_, i) => {
    const h = i % 12 || 12;
    return h + (i < 12 ? 'am' : 'pm');
  });
  const totals = new Array(24).fill(0);
  const counts = new Array(24).fill(0);
  data.forEach(tx => {
    const raw = tx.date || tx.created_at || tx.createdAt;
    if (!raw) return;
    const h = new Date(raw).getHours();
    totals[h] += tx[analyticsView] || tx.net || 0;
    counts[h]++;
  });
  const avgs = totals.map((t, i) => counts[i] > 0 ? +(t / counts[i]).toFixed(2) : 0);
  if (analyticsCharts['by-hour']) analyticsCharts['by-hour'].destroy();
  analyticsCharts['by-hour'] = new Chart(ctx, {
    type: 'bar',
    data: { labels: hourLabels, datasets: [{ data: avgs, backgroundColor: '#ffffff', borderRadius: 4, borderSkipped: false }] },
    options: { ...CHART_DEFAULTS, scales: { ...CHART_DEFAULTS.scales,
      x: { ...CHART_DEFAULTS.scales.x, grid: { display: false }, ticks: { ...CHART_DEFAULTS.scales.x.ticks, maxTicksLimit: 12 } } },
      plugins: { ...CHART_DEFAULTS.plugins, tooltip: { callbacks: { label: c => ` ${fmt(c.raw)}` } } } }
  });
}

function makeSparkline(id, values, color) {
  const ctx = document.getElementById(id);
  if (!ctx || !values.length) return;
  if (analyticsCharts[id]) analyticsCharts[id].destroy();
  analyticsCharts[id] = new Chart(ctx, {
    type: 'line',
    data: { labels: values.map((_, i) => i),
      datasets: [{ data: values, borderColor: color, borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0.4 }] },
    options: { responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { enabled: false } },
      scales: { x: { display: false }, y: { display: false } } }
  });
}

function renderSparklines(data) {
  const field = analyticsView;
  const { values: allVals } = buildDailyTotals(data, field);
  makeSparkline('chart-sparkline-total', allVals, '#6366f1');
  const now = new Date();
  const monthData = data.filter(tx => {
    const d = new Date(tx.date || tx.created_at || tx.createdAt || 0);
    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
  });
  const { values: monthVals } = buildDailyTotals(monthData, field);
  makeSparkline('chart-sparkline-month', monthVals, '#6366f1');
}

// ‚îÄ‚îÄ‚îÄ INBOX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadInbox() {
  const accountId = document.getElementById('inbox-acct').value;
  if (!accountId) return;
  const listEl = document.getElementById('inbox-list');
  listEl.innerHTML = '<div class="loading">Loading conversations...</div>';
  try {
    const d = await api(`/api/conversations?accountId=${accountId}&filter=${inboxFilter}`);
    inboxConvos = d.conversations || [];
    renderConvoList(inboxConvos);
  } catch (e) {
    listEl.innerHTML = `<div class="empty">${e.message}</div>`;
    toast('Inbox error: ' + e.message, 'error');
  }
}

function renderConvoList(convos) {
  const listEl = document.getElementById('inbox-list');
  if (!convos.length) {
    listEl.innerHTML = '<div class="empty">No conversations found</div>';
    return;
  }
  const search = document.getElementById('inbox-search').value.toLowerCase();
  const filtered = search
    ? convos.filter(c => (c.fan?.username||'').toLowerCase().includes(search) || (c.fan?.display_name||'').toLowerCase().includes(search))
    : convos;
  listEl.innerHTML = filtered.map(c => {
    const fan = c.fan || {};
    const name = fan.display_name || fan.username || 'Unknown fan';
    const initials = name.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();
    return `<div class="conv-item${c.is_unread?' unread':''}${c.id===activeConvoId?' active':''}" onclick="openConvo('${c.id}','${encodeName(name)}')">
      <div class="conv-avatar">${fan.avatar_url ? `<img src="${fan.avatar_url}" onerror="this.parentElement.textContent='${initials}'">` : initials}</div>
      <div class="conv-info">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div class="conv-name">${name}</div>
          <div class="conv-time">${shortTime(c.last_message_at)}</div>
        </div>
        <div class="conv-preview">${c.last_message_preview || '‚Äî'}</div>
      </div>
      ${c.is_unread ? '<div class="unread-dot"></div>' : ''}
    </div>`;
  }).join('');
}

function encodeName(name) { return encodeURIComponent(name); }
function filterConvos() { renderConvoList(inboxConvos); }

function setFilter(btn, filter) {
  inboxFilter = filter;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  loadInbox();
}

async function openConvo(id, encodedName) {
  activeConvoId = id;
  const name = decodeURIComponent(encodedName);
  const main = document.getElementById('convo-main');
  main.innerHTML = `
    <div class="convo-topbar">
      <div><div class="convo-fan-name">${name}</div><div class="convo-fan-meta">Loading...</div></div>
      <button class="btn-sm" onclick="openConvo('${id}','${encodedName}')">‚Üª</button>
    </div>
    <div class="convo-msgs" id="msgs-box"><div class="loading">Loading messages...</div></div>
    <div class="convo-input-wrap">
      <textarea class="convo-input" id="reply-input" placeholder="Type a message..." rows="2" onkeydown="handleMsgKey(event,'${id}')"></textarea>
      <button class="btn-send" onclick="sendMsg('${id}')">Send</button>
    </div>`;
  document.querySelectorAll('.conv-item').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.conv-item').forEach(el => {
    if (el.getAttribute('onclick')?.includes(id)) el.classList.add('active');
  });
  try {
    const d = await api(`/api/conversations/${id}`);
    activeConvoData = d;
    const fan = d.conversation?.fan;
    activeFanId = fan?.id || null;
    main.querySelector('.convo-fan-meta').textContent =
      `@${fan?.username || '‚Äî'} ¬∑ ${fan?.subscription_status || ''} ¬∑ Spend: ${fmt(fan?.spend_30d)} (30d)`;
    const msgs = d.messages || [];
    const box = document.getElementById('msgs-box');
    if (!msgs.length) {
      box.innerHTML = '<div class="empty">No messages yet</div>';
    } else {
      box.innerHTML = msgs.map(m => {
        const out = m.direction === 'outbound';
        return `<div class="msg ${out?'outbound':'inbound'}">
          <div class="msg-bubble">${escHtml(m.content || '[Media]')}</div>
          <div class="msg-time">${shortTime(m.sent_at)}</div>
        </div>`;
      }).join('');
      box.scrollTop = box.scrollHeight;
    }
    // Show fan detail panel with DB data first, then fetch live insights
    showFanDetailPanel(d);
  } catch (e) {
    main.querySelector('#msgs-box').innerHTML = `<div class="empty">Error: ${e.message}</div>`;
  }
}

// ‚îÄ‚îÄ‚îÄ FAN DETAIL PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function showFanDetailPanel(data) {
  const panel = document.getElementById('fan-detail-panel');
  panel.classList.add('visible');
  const fan = data.conversation?.fan || {};

  // Populate with DB fields first (instant)
  populatePanelFromDb(fan);

  // Nickname
  const nickname = fan.nickname || '';
  document.getElementById('fdp-nickname-display').textContent = nickname;
  document.getElementById('fdp-nickname-input').value = nickname;
  nicknameEditMode = false;
  document.getElementById('fdp-nickname-display').style.display = 'block';
  document.getElementById('fdp-nickname-edit').style.display = 'none';

  // Notes
  renderFanNotes(fan.fan_notes || []);
  document.getElementById('fdp-notes-textarea').value = fan.notes || '';

  // Summary reset
  document.getElementById('fdp-summary-result').style.display = 'none';
  document.getElementById('fdp-summary-result').textContent = '';

  // Fetch live Fanvue Insights if we have a fan ID ‚Äî unwrap the { insights: {...} } envelope
  if (activeFanId) {
    setInsightsLoading(true);
    api(`/api/fans/${activeFanId}/insights`)
      .then(d => populatePanelFromInsights(d.insights))
      .catch(() => { /* silently keep DB values */ })
      .finally(() => setInsightsLoading(false));
  }
}

function populatePanelFromDb(fan) {
  // Spending ‚Äî from DB fields
  document.getElementById('fdp-total-spent').textContent = fmt(fan.lifetime_spend || 0);
  if (fan.subscribed_at) {
    const d = new Date(fan.subscribed_at);
    document.getElementById('fdp-since').textContent = 'Since ' + d.toLocaleDateString([], { month: 'short', year: 'numeric' });
  } else {
    document.getElementById('fdp-since').textContent = '';
  }
  document.getElementById('fdp-last-spend').textContent = fan.last_spend_at ? timeAgo(fan.last_spend_at) : 'N/A';
  document.getElementById('fdp-ppv-total').textContent = fmt(fan.ppv_total || 0);
  document.getElementById('fdp-ppv-avg').textContent = fmt(fan.ppv_avg || 0) + ' avg';
  document.getElementById('fdp-tip-total').textContent = fmt(fan.tip_total || 0);
  document.getElementById('fdp-tip-avg').textContent = fmt(fan.tip_avg || 0) + ' avg';

  // Subscription ‚Äî from DB fields
  const fanType = fan.fan_type || fan.subscription_status || 'Follower';
  document.getElementById('fdp-fan-type').textContent = fanType.charAt(0).toUpperCase() + fanType.slice(1);
  document.getElementById('fdp-sub-cost').textContent = fan.subscription_price ? fmt(fan.subscription_price) : '-';
  document.getElementById('fdp-sub-duration').textContent = fan.subscription_duration || '1 month';
  document.getElementById('fdp-sub-renew').textContent = fan.auto_renew != null ? (fan.auto_renew ? 'Yes' : 'No') : '-';
}

function populatePanelFromInsights(ins) {
  if (!ins) return;

  // Spending
  document.getElementById('fdp-total-spent').textContent = fmt(ins.lifetime_spend);
  if (ins.subscription_started_at) {
    const d = new Date(ins.subscription_started_at);
    document.getElementById('fdp-since').textContent = 'Since ' + d.toLocaleDateString([], { month: 'short', year: 'numeric' });
  }
  document.getElementById('fdp-last-spend').textContent = ins.last_purchase_at ? timeAgo(ins.last_purchase_at) : 'N/A';
  document.getElementById('fdp-ppv-total').textContent = fmt(ins.ppv_total);
  document.getElementById('fdp-ppv-avg').textContent = ''; // not returned by API
  document.getElementById('fdp-tip-total').textContent = fmt(ins.tip_total);
  document.getElementById('fdp-tip-avg').textContent = ''; // not returned by API

  // Subscription
  if (ins.fan_type) {
    const label = ins.fan_type.charAt(0).toUpperCase() + ins.fan_type.slice(1);
    document.getElementById('fdp-fan-type').textContent = label;
    // Colour the badge by type
    const badge = document.getElementById('fdp-fan-type');
    badge.style.background = ins.fan_type === 'subscriber' ? 'var(--accent)' :
                             ins.fan_type === 'fan'        ? 'var(--blue)'  :
                             ins.fan_type === 'blocked'    ? 'var(--red)'   : 'var(--text3)';
  }
  document.getElementById('fdp-sub-cost').textContent = fmt(ins.subscription_total) || '-';
  // Duration: calculate from started_at ‚Üí renews_at
  if (ins.subscription_started_at && ins.subscription_renews_at) {
    const start = new Date(ins.subscription_started_at);
    const renew = new Date(ins.subscription_renews_at);
    const diffDays = Math.round((renew - start) / (1000*60*60*24));
    document.getElementById('fdp-sub-duration').textContent = diffDays <= 32 ? '1 month' : diffDays + ' days';
  }
  document.getElementById('fdp-sub-renew').textContent =
    ins.auto_renew != null ? (ins.auto_renew ? `Yes ‚Äî renews ${fmtDate(ins.subscription_renews_at)}` : 'No') : '-';
}

function setInsightsLoading(loading) {
  // Subtly dim the spending value while loading, restore after
  const el = document.getElementById('fdp-total-spent');
  if (loading) {
    el.style.opacity = '0.4';
  } else {
    el.style.opacity = '1';
  }
}

function renderFanNotes(notes) {
  const list = document.getElementById('fdp-notes-list');
  const filtered = activeNoteFilter === 'all' ? notes
    : notes.filter(n => n.category === activeNoteFilter);
  if (!filtered.length) {
    list.innerHTML = '<div class="fdp-notes-empty">No facts found</div>';
    return;
  }
  list.innerHTML = filtered.map(n =>
    `<div class="fdp-note-item">${escHtml(n.content || n.text || String(n))}</div>`
  ).join('');
}

function setNoteFilter(btn, filter) {
  activeNoteFilter = filter;
  document.querySelectorAll('.fdp-notes-filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const fan = activeConvoData?.conversation?.fan || {};
  renderFanNotes(fan.fan_notes || []);
}

function toggleNicknameEdit() {
  nicknameEditMode = !nicknameEditMode;
  document.getElementById('fdp-nickname-display').style.display = nicknameEditMode ? 'none' : 'block';
  document.getElementById('fdp-nickname-edit').style.display = nicknameEditMode ? 'flex' : 'none';
  if (nicknameEditMode) document.getElementById('fdp-nickname-input').focus();
}

async function saveNickname() {
  if (!activeConvoId) return;
  const nickname = document.getElementById('fdp-nickname-input').value.trim();
  try {
    await api(`/api/conversations/${activeConvoId}/nickname`, { method: 'PATCH', body: { nickname } });
    document.getElementById('fdp-nickname-display').textContent = nickname;
    toggleNicknameEdit();
    toast('Nickname saved', 'success');
  } catch (e) {
    toast('Failed to save nickname: ' + e.message, 'error');
  }
}

async function addFanNote() {
  if (!activeFanId) return;
  const input = document.getElementById('fdp-note-input');
  const text = input.value.trim();
  if (!text) return;
  try {
    await api(`/api/fans/${activeFanId}/notes`, { method: 'POST', body: { content: text, category: 'all' } });
    input.value = '';
    const fan = activeConvoData?.conversation?.fan || {};
    const notes = fan.fan_notes || [];
    notes.push({ content: text, category: 'all' });
    fan.fan_notes = notes;
    renderFanNotes(notes);
    toast('Note added', 'success');
  } catch (e) {
    toast('Failed to add note: ' + e.message, 'error');
  }
}

async function saveFanNotes() {
  if (!activeFanId) return;
  const notes = document.getElementById('fdp-notes-textarea').value;
  try {
    await api(`/api/fans/${activeFanId}/general-notes`, { method: 'PATCH', body: { notes } });
  } catch (e) {
    // silent fail on blur save
  }
}

function cycleSummaryPeriod() {
  currentSummaryPeriod = (currentSummaryPeriod + 1) % summaryPeriods.length;
  document.getElementById('fdp-period-btn').textContent = summaryPeriods[currentSummaryPeriod];
}

function generateChatSummary() {
  if (!activeConvoData) return;
  const msgs = activeConvoData.messages || [];
  const periodHours = [24, 24*7, 24*30][currentSummaryPeriod];
  const since = Date.now() - periodHours * 3600 * 1000;
  const recent = msgs.filter(m => new Date(m.sent_at).getTime() > since);
  const resultEl = document.getElementById('fdp-summary-result');
  if (!recent.length) {
    resultEl.textContent = 'No messages in this time period.';
    resultEl.style.display = 'block';
    return;
  }
  const inbound = recent.filter(m => m.direction === 'inbound');
  const outbound = recent.filter(m => m.direction === 'outbound');
  const summary = `${summaryPeriods[currentSummaryPeriod]}: ${recent.length} messages (${inbound.length} from fan, ${outbound.length} from you). ` +
    (inbound.length ? `Last fan message: "${(inbound[inbound.length-1].content || '').substring(0, 80)}..."` : '');
  resultEl.textContent = summary;
  resultEl.style.display = 'block';
}

async function sendMsg(convoId) {
  const input = document.getElementById('reply-input');
  const content = input.value.trim();
  if (!content) return;
  input.value = '';
  try {
    await api(`/api/conversations/${convoId}/messages`, { method: 'POST', body: { content } });
    openConvo(convoId, encodeURIComponent(document.querySelector('.convo-fan-name')?.textContent || ''));
    toast('Sent', 'success');
  } catch (e) {
    toast('Send failed: ' + e.message, 'error');
    input.value = content;
  }
}

function handleMsgKey(e, id) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(id); }
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ‚îÄ‚îÄ‚îÄ SCRIPTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadScripts() {
  const tbody = document.getElementById('scripts-table');
  tbody.innerHTML = '<tr><td colspan="4" class="loading">Loading...</td></tr>';
  try {
    const d = await api('/api/scripts');
    const scripts = d.scripts || d || [];
    if (!scripts.length) {
      tbody.innerHTML = '<tr><td colspan="4" class="empty">No scripts yet</td></tr>';
      return;
    }
    tbody.innerHTML = scripts.map(s => `
      <tr>
        <td style="font-weight:500">${s.name}</td>
        <td>${s.script_steps?.length || s.step_count || '‚Äî'}</td>
        <td style="color:var(--text2)">${s.trigger_event || s.trigger || 'Manual'}</td>
        <td>${s.is_active ? '<span class="badge badge-green">Active</span>' : '<span class="badge badge-gray">Inactive</span>'}</td>
      </tr>`).join('');
  } catch (e) {
    tbody.innerHTML = `<tr><td colspan="4" class="empty">Error: ${e.message}</td></tr>`;
  }
}

// ‚îÄ‚îÄ‚îÄ FANS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadFans() {
  const accountId = document.getElementById('fans-acct').value;
  if (!accountId) return;
  const tbody = document.getElementById('fans-table');
  tbody.innerHTML = '<tr><td colspan="5" class="loading">Loading fans...</td></tr>';
  try {
    const d = await api(`/api/fans?accountId=${accountId}&limit=50`);
    const fans = d.fans || d || [];
    if (!fans.length) {
      tbody.innerHTML = '<tr><td colspan="5" class="empty">No fans found</td></tr>';
      return;
    }
    tbody.innerHTML = fans.map(f => `
      <tr>
        <td><div style="display:flex;align-items:center;gap:8px;">
          ${f.avatar_url ? `<img src="${f.avatar_url}" style="width:26px;height:26px;border-radius:50%;object-fit:cover;">` : ''}
          <div><div style="font-weight:500">${f.display_name || f.username || '‚Äî'}</div>
          <div style="font-size:11px;color:var(--text3)">@${f.username||''}</div></div>
        </div></td>
        <td style="color:var(--green)">${fmt(f.spend_30d)}</td>
        <td style="color:var(--text2)">${fmt(f.lifetime_spend)}</td>
        <td>${f.spend_tier ? `<span class="badge badge-purple">${f.spend_tier}</span>` : '‚Äî'}</td>
        <td style="color:var(--text2)">${timeAgo(f.last_active_at)}</td>
      </tr>`).join('');
  } catch (e) {
    tbody.innerHTML = `<tr><td colspan="5" class="empty">Error: ${e.message}</td></tr>`;
  }
}

// ‚îÄ‚îÄ‚îÄ TEAM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadFullTeam() {
  const tbody = document.getElementById('full-team-table');
  try {
    const d = await api('/api/team');
    const members = d.members || d || [];
    if (!members.length) {
      tbody.innerHTML = '<tr><td colspan="3" class="empty">No team members</td></tr>';
      return;
    }
    tbody.innerHTML = members.map(u => `
      <tr>
        <td style="font-weight:500">${u.name}</td>
        <td style="color:var(--text2)">${u.email}</td>
        <td>${roleBadge(u.role)}</td>
      </tr>`).join('');
  } catch (e) {
    tbody.innerHTML = `<tr><td colspan="3" class="empty">Error: ${e.message}</td></tr>`;
  }
}

// ‚îÄ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', () => {
  if (token) {
    initApp();
  }
  // enter key on auth fields
  ['f-email','f-pass','f-name','f-agency'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('keydown', e => { if (e.key==='Enter') authSubmit(); });
  });
});
</script>
</body>
</html>
